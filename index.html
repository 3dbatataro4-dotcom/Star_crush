<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FFFDE7">

    <link rel="icon" href="https://file.garden/aWe99vhwaGcNwkok/%E6%B6%88%E6%B6%88%E6%A8%82/item_5.png">

    <title>è§’è‰²æ´¾å°ï¼šç„¡ç›¡æ˜Ÿå…‰ Ver.Final</title>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* é«˜ç´šé¦¬å¡é¾é…è‰² */
            --primary: #ffcdd2; /* light pink */
            --primary-dark: #e91e63; /* hot pink */
            --secondary: #b3e5fc; /* light blue */
            --accent: #fff9c4; /* light yellow */
            --accent-dark: #ffeb3b; /* yellow */
            --text-main: #6d4c41;
            --text-sub: #a1887f;
            --glass: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.9);
            --shadow-float: 0 8px 25px rgba(149, 117, 205, 0.1);
            --grid-cols: 6;
            --grid-rows: 9;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; font-family: 'Zen Maru Gothic', sans-serif; }

        html, body {
            margin: 0; padding: 0;
            width: 100vw; height: 100vh;
            overflow: hidden;
        }

        body {
            background-color: #FFFDE7;
            display: flex; flex-direction: column;
            color: var(--text-main);
            transition: background-color 0.5s;
        }

        body.boss-level {
            background-color: #372f4b;
        }
        
        body.boss-berserk {
            background-color: #4a0000 !important;
        }
        body.boss-berserk #background-layer {
            filter: sepia(1) hue-rotate(-50deg) saturate(3) brightness(0.7);
            animation: bg-breathe 0.5s infinite ease-in-out alternate !important;
        }

        /* --- é ‚éƒ¨è³‡è¨Šå€ --- */
        header {
            flex: 0 0 auto;
            padding: max(10px, env(safe-area-inset-top)) 20px 5px;
            background: var(--glass);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--glass-border);
            z-index: 20;
            display: flex; flex-direction: column; gap: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        }

        /* Fever æ¢æ¨£å¼ */
        .fever-container {
            flex: 1; margin: 0 15px; height: 24px;
            background: rgba(0,0,0,0.08); border-radius: 12px;
            border: 2px solid #FFF; position: relative; overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }
        .fever-fill {
            height: 100%; width: 0%;
            background: linear-gradient(90deg, #FF8A80, #D500F9);
            transition: width 0.3s ease-out;
            box-shadow: 0 0 15px #D500F9;
        }
        .fever-text {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem; font-weight: 900; color: #FFF; text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .info-row { display: flex; justify-content: space-between; align-items: center; }
        .header-btn {
            background: #FFF; border: 2px solid var(--secondary);
            width: 40px; height: 40px; border-radius: 50%;
            font-size: 1.2rem; color: var(--text-sub);
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            cursor: pointer; transition: all 0.2s;
        }
        .header-btn:active { transform: scale(0.9); }
        
        .level-badge {
            background: #FFF; padding: 5px 15px; border-radius: 30px;
            font-size: 1.1rem; font-weight: 900; color: var(--primary-dark);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 2px solid var(--accent-dark);
            display: flex; align-items: center; gap: 5px;
        }
        
        .total-score { font-size: 0.9rem; color: var(--text-sub); font-weight: bold; }
        .total-score span { font-size: 1.2rem; color: var(--text-main); font-weight: 900; transition: transform 0.15s; display: inline-block; }

        /* é€²åº¦æ¢ */
        .progress-container {
            width: 100%; height: 24px; background: rgba(0,0,0,0.15); 
            border-radius: 15px; overflow: hidden; position: relative; transition: opacity 0.3s;
            border: 3px solid #FFF;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        #normal-progress { width: 100%; height: 100%; position: relative; }
        .progress-fill { 
            height: 100%; background: linear-gradient(90deg, #ff9a9e, #fad0c4, #fad0c4, #a18cd1, #fbc2eb); 
            width: 0%; transition: width 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: 0 0 15px rgba(255, 154, 158, 0.6);
            transition: width 0.4s cubic-bezier(0.25, 1, 0.5, 1), box-shadow 0.3s;
        }
        .progress-fill.highlight {
            box-shadow: 0 0 15px #FFF, 0 0 25px #ff9a9e;
        }
        .target-text { 
            position: absolute; width: 100%; text-align: center; top: -1px; 
            font-size: 0.8rem; color: #6d4c41; font-weight: 900; line-height: 24px;
            text-shadow: 0 0 3px #FFF, 0 0 5px #FFF;
        }

        /* BOSS è¡€æ¢ */
        #boss-hp-container {
            width: 100%; height: 20px; background: rgba(0,0,0,0.3);
            border-radius: 10px; overflow: hidden; position: relative;
            border: 2px solid #111; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: none;
        }
        #boss-hp-fill {
            height: 100%; background: linear-gradient(90deg, #f83293, #ff0d37);
            width: 100%; transition: width 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: 0 0 10px #ff0d37;
        }
        #boss-hp-text {
            position: absolute; width: 100%; text-align: center; top: 1px;
            font-size: 0.8rem; color: #FFF; font-weight: 900; text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        /* --- éŠæˆ²ä¸»èˆå° --- */
        #game-stage {
            flex: 1;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            position: relative;
            padding: 10px 10px 0;
            overflow: hidden;
        }

        #background-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://file.garden/aWe99vhwaGcNwkok/%E6%B6%88%E6%B6%88%E6%A8%82/Gemini_Generated_Image_rk1jeork1jeork1j.png');
            background-size: cover;
            background-position: center;
            z-index: -1;
            animation: bg-breathe 20s infinite ease-in-out alternate;
        }
        @keyframes bg-breathe { from { transform: scale(1); } to { transform: scale(1.1); } }

        #boss-container {
            position: absolute; top: -20px; width: 100%; text-align: center;
            z-index: 15; pointer-events: none; display: none;
        }
        #boss-img {
            width: 120px; height: 120px; object-fit: contain;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5));
            animation: boss-float 4s infinite ease-in-out;
        }
        @keyframes boss-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        .boss-damaged { animation: boss-damage-shake 0.3s; }
        .boss-attacking { animation: boss-attack-charge 1s forwards !important; }
        @keyframes boss-attack-charge {
            0% { transform: scale(1) translateY(0); filter: brightness(1); }
            50% { transform: scale(1.3) translateY(-20px); filter: brightness(1.5) drop-shadow(0 0 30px #ff0000); }
            100% { transform: scale(1) translateY(0); filter: brightness(1); }
        }
        @keyframes boss-damage-shake { 0%, 100% { transform: translateY(0) rotate(0); } 25% { transform: translateY(-5px) rotate(-3deg); } 75% { transform: translateY(-5px) rotate(3deg); } }

        #boss-dialogue {
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%) scale(0.8);
            background: rgba(255, 255, 255, 0.95);
            border: 4px solid var(--primary-dark);
            color: var(--text-main);
            padding: 10px 20px; border-radius: 30px;
            font-weight: 900; font-size: 1.1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            opacity: 0; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 100; pointer-events: none;
        }
        #boss-dialogue.show { opacity: 1; transform: translateX(-50%) scale(1); }

        /* æ£‹ç›¤å®¹å™¨ */
        #grid-container {
            width: 100%; max-width: 450px;
            aspect-ratio: 6 / 9;
            background: rgba(255,255,255,0.25);
            backdrop-filter: blur(5px);
            border-radius: 24px;
            border: 1px solid rgba(255,255,255,0.5);
            box-shadow: var(--shadow-float), inset 0 0 30px rgba(255,255,255,0.3);
            position: relative;
            touch-action: none;
            flex-shrink: 0; 
            z-index: 10;
            margin-top: 50px; /* ç‚º BOSS ç•™å‡ºç©ºé–“ */
        }
        
        #blind-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 50%, transparent 30%, rgba(0,0,0,0.85) 60%);
            z-index: 70;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
        }
        #blind-overlay.show {
            opacity: 1;
        }

        #grid { width: 100%; height: 100%; position: relative; z-index: 10; }

        /* --- æ–¹å¡Š Tile --- */
        .tile {
            position: absolute;
            width: calc(100% / var(--grid-cols));
            height: calc(100% / var(--grid-rows));
            padding: 4px; z-index: 10;
            transition: top 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), left 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .tile-inner {
            width: 100%; height: 100%;
            background: #FFF; border-radius: 50%;
            box-shadow: 0 4px 8px rgba(93, 64, 55, 0.12), inset 0 -3px 0 rgba(0,0,0,0.05);
            overflow: hidden; position: relative;
            transform: scale(0.95); transition: transform 0.15s;
            border: 2px solid transparent;
        }
        .tile img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }

        /* é»æ“Šæ™‚çš„æœå‡å‹•ç•« */
        .tile.pressed .tile-inner { transform: scale(0.85); }

        /* æŠ€èƒ½ç‹€æ…‹ */
        .tile.skill-ready .tile-inner {
            border-color: transparent;
            box-shadow: 0 0 0 3px var(--accent), 0 0 25px var(--accent), inset 0 0 10px #FFF;
            animation: breathe 1.2s infinite ease-in-out alternate;
        }
        .tile.skill-ready::after {
            content: 'âœ¦'; position: absolute; bottom: 2px; right: 2px;
            color: var(--primary-dark); font-size: 14px; font-weight: 900;
            text-shadow: 0 0 5px #FFF; animation: spin 3s infinite linear;
        }

        /* Fever æ¨¡å¼ç‰¹æ•ˆ */
        /* ç§»é™¤åŸæœ¬çš„ hue-rotateï¼Œæ”¹ç‚ºèƒŒæ™¯æµå…‰æˆ–å…¶ä»–ä¸å½±éŸ¿è§’è‰²è‰²ç›¸çš„æ•ˆæœ */
        body.fever-mode::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(45deg, rgba(255,0,0,0.1), rgba(0,255,0,0.1), rgba(0,0,255,0.1));
            background-size: 400% 400%; animation: fever-bg 3s ease infinite; pointer-events: none; z-index: 1;
        }
        @keyframes fever-bg { 0% {background-position: 0% 50%} 50% {background-position: 100% 50%} 100% {background-position: 0% 50%} }

        @keyframes rainbow-flow {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }
        body.fever-mode .tile .tile-inner {
            border: 3px solid transparent;
            background: linear-gradient(white, white) padding-box, 
                        linear-gradient(90deg, #ff9a9e, #fad0c4, #fbc2eb, #a18cd1, #a1c4fd, #c2e9fb) border-box;
            background-size: 200% 200%;
            animation: rainbow-flow 2s linear infinite, pulse-rainbow 0.5s infinite alternate;
        }
        @keyframes pulse-rainbow { from { transform: scale(0.95); } to { transform: scale(1.02); } }

        /* å†°å¡Šéšœç¤™æ¨£å¼ */
        .tile.frozen .tile-inner { filter: brightness(0.9) sepia(0.2) hue-rotate(180deg) saturate(1.5); }
        .tile.frozen::after {
            content: 'â„ï¸'; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); font-size: 24px; z-index: 20;
            text-shadow: 0 0 5px #FFF; pointer-events: none;
        }
        /* çŸ³é ­éšœç¤™æ¨£å¼ */
        .tile.stone .tile-inner { filter: grayscale(1) brightness(0.6); background: #555; }
        .tile.stone::after {
            content: 'ğŸ—¿'; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); font-size: 24px; z-index: 20;
            text-shadow: 0 0 5px #FFF; pointer-events: none;
        }

        @keyframes breathe { 0% { filter: brightness(1); transform: scale(0.95); } 100% { filter: brightness(1.15); transform: scale(1.02); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* éœ‡å‹•ç‰¹æ•ˆ */
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        /* æ¶ˆé™¤å‹•ç•« */
        .tile.matched .tile-inner { animation: pop 0.35s forwards ease-out !important; }
        @keyframes pop { 0% {transform: scale(1);} 50% {transform: scale(1.4); opacity: 0.8;} 100% {transform: scale(0.2); opacity: 0;} }

        /* --- æ‡¸æµ®å°è©±æ°£æ³¡ --- */
        .float-dialogue-wrapper {
            position: absolute; 
            bottom: 20px; 
            left: 0; width: 100%;
            display: flex; justify-content: center;
            pointer-events: none;
            z-index: 100;
        }

        #dialogue-bubble {
            background: rgba(255, 255, 255, 0.95);
            border: 3px solid var(--primary);
            border-radius: 50px;
            padding: 8px 20px 8px 8px;
            display: flex; align-items: center; gap: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: translateY(30px) scale(0.8); opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 90%;
        }

        #dialogue-bubble.show { transform: translateY(0) scale(1); opacity: 1; }

        .d-avatar {
            width: 50px; height: 50px; border-radius: 50%;
            border: 3px solid var(--accent); background: #FFF;
            object-fit: cover; flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .d-content { display: flex; flex-direction: column; justify-content: center; }
        .d-name { font-size: 0.75rem; color: var(--primary-dark); font-weight: 900; margin-bottom: 2px; }
        .d-text { font-size: 0.9rem; color: var(--text-main); font-weight: bold; line-height: 1.2; }

        /* --- æŠ€èƒ½ Cut-in å‹•ç•« --- */
        #skill-cutin-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 90; display: none;
            align-items: center; justify-content: center;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
        }
        .cutin-container {
            position: relative; width: 100%; height: 300px; display: flex; align-items: center; justify-content: center;
        }
        .cutin-img {
            height: 100%; width: auto; object-fit: contain;
            filter: drop-shadow(0 0 20px rgba(255,255,255,0.9));
            transform: translateX(-100px); opacity: 0;
        }
        .cutin-active .cutin-img { animation: cutin-slide 1.5s cubic-bezier(0.19, 1, 0.22, 1) forwards; }
        @keyframes cutin-slide { 0% { transform: translateX(-50%) scale(0.8); opacity: 0; } 20% { transform: translateX(0) scale(1.2); opacity: 1; } 80% { transform: translateX(0) scale(1); opacity: 1; } 100% { transform: translateX(50%) scale(1.2); opacity: 0; } }

        /* è¯æ”œæŠ€ Cut-in */
        .synergy-container {
            position: absolute; width: 100%; height: 100%; 
            display: none;
            align-items: center; justify-content: center;
            gap: 10px;
        }
        .synergy-img {
            height: 50%; width: auto; object-fit: contain;
            filter: drop-shadow(0 0 15px rgba(255,215,0,0.8));
            opacity: 0;
        }
        .cutin-active .synergy-container { display: flex; }
        .cutin-active .synergy-img.left { animation: syn-slide-left 2s cubic-bezier(0.19, 1, 0.22, 1) forwards; }
        .cutin-active .synergy-img.right { animation: syn-slide-right 2s cubic-bezier(0.19, 1, 0.22, 1) forwards; }
        .synergy-text {
            font-size: 4rem; color: #FFF; font-weight: 900; 
            text-shadow: 0 0 10px #FFD700, 0 0 20px #FF6F00;
            z-index: 95; opacity: 0;
            animation: syn-text-pop 2s cubic-bezier(0.19, 1, 0.22, 1) forwards;
        }
        @keyframes syn-slide-left { 0% { transform: translateX(-100%) scale(0.8); opacity: 0; } 20% { transform: translateX(0) scale(1); opacity: 1; } 80% { transform: translateX(0) scale(1); opacity: 1; } 100% { transform: translateX(-50%) scale(1); opacity: 0; } }
        @keyframes syn-slide-right { 0% { transform: translateX(100%) scale(0.8); opacity: 0; } 20% { transform: translateX(0) scale(1); opacity: 1; } 80% { transform: translateX(0) scale(1); opacity: 1; } 100% { transform: translateX(50%) scale(1); opacity: 0; } }
        @keyframes syn-text-pop { 0% { transform: scale(0); opacity: 0; } 30% { transform: scale(1.2); opacity: 1; } 80% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }

        /* --- åº•éƒ¨é“å…·æ¬„ --- */
        #bottom-dock {
            flex: 0 0 auto; width: 100%; background: var(--glass);
            backdrop-filter: blur(16px);
            padding: 15px 20px max(20px, env(safe-area-inset-bottom));
            border-radius: 30px 30px 0 0;
            box-shadow: 0 -10px 40px rgba(149, 117, 205, 0.08);
            display: flex; justify-content: center; gap: 20px; align-items: center;
            z-index: 40;
        }
        
        .item-btn {
            position: relative; width: 65px; height: 65px; border-radius: 22px;
            background: rgba(255,255,255,0.8); border: none;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 5px 10px rgba(0,0,0,0.05); transition: all 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .item-btn:active { transform: translateY(5px); box-shadow: 0 0 0; }
        .item-btn.active { 
            background: var(--accent); border: 2px solid var(--accent-dark); 
            box-shadow: 0 0 20px var(--accent-dark); transform: translateY(-3px) scale(1.05); 
        }
        .item-btn img { width: 36px; height: 36px; margin-bottom: 2px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1)); }
        .item-count {
            position: absolute; top: -6px; right: -6px;
            background: linear-gradient(45deg, #FF5252, #FF1744); color: #FFF; font-size: 0.75rem; 
            width: 22px; height: 22px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; 
            border: 2px solid #FFF; font-weight: 900; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* --- ç‰¹æ•ˆå±¤ --- */
        #vfx-layer { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; z-index: 50; overflow: hidden; }
        .float-text {
            position: absolute; font-weight: 900; color: var(--primary-dark);
            text-shadow: 2px 2px 0 #FFF; animation: floatUp 1.2s forwards; font-size: 1.5rem; 
            white-space: nowrap; z-index: 60;
        } 
        @keyframes floatUp { 0% {transform:translate(-50%, 0) scale(0.5); opacity: 0;} 20% {transform:translate(-50%, -20px) scale(1.2); opacity: 1;} 100% {transform:translate(-50%, -80px) scale(1); opacity: 0;} }

        /* --- æ¨™é¡Œç•«é¢ --- */
        #title-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #FFFDE7 0%, #FFCCBC 100%);
            z-index: 1000; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; text-align: center;
        }
        .title-card {
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); padding: 40px; border-radius: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1); border: 2px solid #FFF;
            width: 85%; max-width: 350px; animation: float 3s infinite ease-in-out;
        }
        @keyframes float { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-15px);} }
        .btn-start {
            background: linear-gradient(45deg, #84fab0, #8fd3f4);
            color: #FFF; border: none; padding: 15px 50px; border-radius: 50px;
            font-size: 1.4rem; font-weight: 900; margin-top: 30px;
            box-shadow: 0 8px 0 #76c4d6, 0 15px 20px rgba(137, 211, 244, 0.4);
            transition: all 0.15s; cursor: pointer;
        }
        .btn-start:active { transform: translateY(8px); box-shadow: 0 0 0 #76c4d6; }
        /* é‡ç½®æŒ‰éˆ•æ¨£å¼ */
.btn-reset {
    background: transparent; 
    border: 2px solid #FFAB91;
    color: #D84315; 
    padding: 8px 20px; 
    border-radius: 30px;
    font-size: 1rem; 
    font-weight: bold; 
    margin-top: 15px;
    cursor: pointer; 
    transition: all 0.2s;
}
.btn-reset:active { transform: scale(0.95); background: var(--primary); color: #FFF; }

        /* --- åœ–é‘‘èˆ‡åŠ‡æƒ… UI --- */
        .gallery-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 15px; padding-bottom: 50px;
        }
        .char-card {
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            opacity: 0.5; filter: grayscale(1); transition: all 0.3s;
        }
        .char-card.unlocked { opacity: 1; filter: grayscale(0); cursor: pointer; }
        .char-card img {
            width: 70px; height: 70px; border-radius: 20px; object-fit: cover;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 3px solid #FFF;
            transition: border-color 0.2s;
        }
        .char-card.selected img { border-color: var(--primary-dark); box-shadow: 0 0 15px var(--primary); }
        .char-card.selected::after {
            content: 'âœ”'; position: absolute; top: -5px; right: -5px; 
            background: var(--primary-dark); color: #FFF; border-radius: 50%; 
            width: 24px; height: 24px; font-size: 14px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .char-name { font-size: 0.8rem; font-weight: bold; color: var(--text-sub); text-align: center; }

        /* è§’è‰²è©³æƒ…å½ˆçª— */
        #char-detail-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2100;
            display: none; align-items: center; justify-content: center;
        }
        .detail-card {
            background: #FFF; width: 85%; max-width: 350px; border-radius: 24px;
            padding: 30px; text-align: center; position: relative;
            animation: modal-pop-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .detail-img { width: 120px; height: 120px; border-radius: 50%; border: 5px solid var(--accent); margin-bottom: 15px; object-fit: cover; }
        .detail-name { font-size: 1.5rem; font-weight: 900; color: var(--primary-dark); margin-bottom: 10px; }
        .detail-desc { font-size: 0.9rem; color: var(--text-main); line-height: 1.6; text-align: left; background: #FFF8E1; padding: 15px; border-radius: 15px; }
        .detail-level { font-size: 1.2rem; color: var(--primary); font-weight: 900; margin-bottom: 10px; }
        .btn-upgrade {
            background: linear-gradient(45deg, #FFD54F, #FFB74D);
            color: #FFF; border: none; padding: 10px 20px; border-radius: 30px;
            font-size: 1rem; font-weight: bold; margin-top: 10px; cursor: pointer;
            box-shadow: 0 4px 0 #FFA000; transition: all 0.1s;
        }
        .btn-upgrade:active { transform: translateY(4px); box-shadow: none; }
        .btn-upgrade:disabled { background: #CCC; box-shadow: none; cursor: not-allowed; }

        .modal-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 2000;
            display: none; 
            flex-direction: column; justify-content: flex-end;
            animation: modal-fade-in 0.3s;
        }
        /* Combo é¡¯ç¤ºç‰¹æ•ˆ */
        #combo-display {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0);
            font-size: 5rem; font-weight: 900; 
            background: linear-gradient(to bottom, #ff9a9e, #fecfef, #a1c4fd);
            -webkit-background-clip: text;
            color: transparent;
            -webkit-text-stroke: 3px #FFF;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.8)) drop-shadow(0 0 20px rgba(255, 182, 193, 0.6));
            text-align: center; white-space: nowrap;
            z-index: 80; pointer-events: none; opacity: 0;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.2s;
        }
        #combo-display.show { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; flex: 0 0 auto; }
        .modal-title { font-size: 1.5rem; font-weight: 900; color: var(--primary-dark); }
        .btn-close { background: #EEE; border: none; width: 40px; height: 40px; border-radius: 50%; font-weight: bold; font-size: 1.2rem; color: #888; }
        .modal-content { flex: 1; overflow-y: auto; padding: 0 20px 20px; }
        @keyframes modal-fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modal-pop-in { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }

        .team-controls {
            background: #FFF8E1; padding: 15px; border-radius: 20px; margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .toggle-btn { background: #CCC; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; color: #FFF; cursor: pointer; transition: all 0.2s; }
        .toggle-btn.active { background: var(--primary); box-shadow: 0 4px 10px rgba(255, 171, 145, 0.4); transform: scale(1.05); }

        #pause-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(8px);
            z-index: 1500;
            display: none; align-items: center; justify-content: center;
            animation: modal-fade-in 0.3s;
        }
        .pause-card {
            background: #FFF; padding: 40px 60px; border-radius: 30px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            border: 2px solid #FFF;
        }

    </style>
</head>
<body>
    <div id="background-layer"></div>
    <header>
        <div class="info-row">
            <div class="level-badge">
                <span>â­ Lv.</span><span id="ui-level">1</span>
            </div>
            <div class="fever-container">
                <div class="fever-fill" id="ui-fever-fill"></div>
                <div class="fever-text" id="ui-fever-text">FEVER</div>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <div class="total-score">ç¸½åˆ†: <span id="ui-total-score">0</span></div>
                <button class="header-btn" id="btn-pause" onclick="togglePause()">â¸ï¸</button>
            </div>
        </div>
        <div class="progress-container">
            <div id="normal-progress">
                <div class="progress-fill" id="ui-progress"></div>
                <div class="target-text">NEXT: <span id="ui-current-score">0</span> / <span id="ui-target">1000</span></div>
            </div>
            <div id="boss-hp-container">
                <div id="boss-hp-fill"></div>
                <div id="boss-hp-text">BOSS HP</div>
            </div>
        </div>
    </header>

    <div id="game-stage">
        <div id="boss-container">
            <img id="boss-img" src="https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E5%86%A5%E7%A5%9E.png">
            <div id="boss-dialogue"></div>
        </div>
        <div id="grid-container">
            <div id="grid"></div>
            <div id="vfx-layer"></div>
            <div id="combo-display"></div>
            <div id="blind-overlay"></div>
            
            <!-- æŠ€èƒ½ Cut-in å±¤ -->
            <div id="skill-cutin-layer">
                <div class="cutin-container"><img class="cutin-img" id="cutin-img" src=""></div>
                <div class="synergy-container" id="synergy-container">
                    <img class="synergy-img left" id="syn-img-1" src="">
                    <div class="synergy-text">LINK!</div>
                    <img class="synergy-img right" id="syn-img-2" src="">
                </div>
            </div>

            <div class="float-dialogue-wrapper">
                <div id="dialogue-bubble">
                    <img class="d-avatar" id="d-img" src="">
                    <div class="d-content">
                        <div class="d-name" id="d-name">åå­—</div>
                        <div class="d-text" id="d-text">å…§å®¹</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åœ–é‘‘ç•«é¢ -->
    <div id="gallery-screen" class="modal-screen">
        <div class="modal-header">
            <h2 class="modal-title">è§’è‰²åœ–é‘‘</h2>
            <button class="btn-close" onclick="closeGallery()">Ã—</button>
        </div>
        <div style="padding: 0 20px;">
            <div class="team-controls">
                <div id="team-status" style="font-weight:bold; color:var(--text-main);">æ¨¡å¼: éš¨æ©Ÿ</div>
                <button id="btn-team-toggle" class="toggle-btn" onclick="toggleTeamMode()">åˆ‡æ›è‡ªé¸</button>
            </div>
        </div>
        <div class="modal-content" id="gallery-content"></div>
    </div>

    <!-- è§’è‰²è©³æƒ… -->
    <div id="char-detail-overlay" onclick="this.style.display='none'">
        <div class="detail-card" id="detail-card" onclick="event.stopPropagation()">
            <img class="detail-img" id="detail-img" src="">
            <div class="detail-level" id="detail-level">Lv.1</div>
            <div class="detail-name" id="detail-name"></div>
            <div class="detail-desc" id="detail-desc"></div>
            <button id="btn-upgrade" class="btn-upgrade" onclick="upgradeChar()">å‡ç´š (èŠ±è²»: 1000)</button>
            <button class="btn-start" style="margin-top:20px; font-size:1rem; padding:10px 30px;" onclick="document.getElementById('char-detail-overlay').style.display='none'">é—œé–‰</button>
        </div>
    </div>

    <div id="bottom-dock">
        <button class="item-btn" id="btn-bomb" onclick="useItem('bomb')">
            <img src="https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E8%AB%BE%E9%83%8E.png">
            <span class="item-count" id="cnt-bomb">3</span>
        </button>
        <button class="item-btn" id="btn-lightning" onclick="useItem('lightning')">
            <img src="https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E5%B0%8F%E9%9B%85%E5%90%84.png">
            <span class="item-count" id="cnt-lightning">3</span>
        </button>
        <button class="item-btn" id="btn-shuffle" onclick="useItem('shuffle')">
            <img src="https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E6%98%9F%E6%98%9F.png">
            <span class="item-count" id="cnt-shuffle">3</span>
        </button>
        <button class="item-btn" onclick="toggleSkillInfo()">
            <img src="https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E5%93%88%E8%98%87.png" style="opacity:0.8">
            <span style="font-size:10px; position:absolute; bottom:5px; color:#888; font-weight:bold;">èªªæ˜</span>
        </button>
    </div>

   <div id="title-screen">
    <div class="title-card">
        <img src="https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E6%98%9F%E6%98%9F.png" style="width:100px; height:100px; border-radius:50%; border:4px solid gold; margin-bottom:15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
        <h1 style="color:#FF8F00; margin:0; text-shadow:2px 2px 0 #FFF;">å…¨æ˜æ˜Ÿ<br>ç„¡ç›¡æ´¾å°</h1>
        <p style="color:#8D6E63; font-weight:bold; margin-top:10px;">ç›®å‰ç­‰ç´š: <span id="title-level">1</span></p>
        
        <button class="btn-start" onclick="startGame()">START</button>
        <br>
        <button class="btn-reset" style="margin-top:10px; border-color:var(--secondary); color:var(--secondary);" onclick="openGallery()">è§’è‰²åœ–é‘‘</button>
        
        <br>
        <button class="btn-reset" onclick="resetGameData()">é‡ç½®é€²åº¦</button>
        </div>
</div>

    <div id="pause-overlay">
        <div class="pause-card">
            <h2 style="color: var(--primary-dark); font-size: 2rem;">PAUSED</h2>
            <button class="btn-start" style="margin-top: 10px;" onclick="togglePause()">RESUME</button>
            <button class="btn-reset" style="margin-top: 15px; border-color: #888; color: #666;" onclick="backToTitle()">TITLE</button>
        </div>
    </div>

    

<script>
    // --- é—œå¡é…ç½® (Level Config) ---
    const LEVEL_CONFIG = {
        1: { target: 3000, ice: 0, stone: 0, shape: 'rect' },
        2: { target: 3000, ice: 3, stone: 0, shape: 'rect' },
        3: { target: 3000, ice: 5, stone: 2, shape: 'cross' },
        4: { target: 3000, ice: 8, stone: 4, shape: 'donut' },
        5: { target: 3000, ice: 10, stone: 6, shape: 'hourglass' }
    };

    // --- 0. éŸ³æ•ˆèˆ‡ BGM ç³»çµ± (Audio System) ---
    const AUDIO_SRC = {
        bgm: "https://file.garden/aWe99vhwaGcNwkok/%E6%B6%88%E6%B6%88%E6%A8%82/AudioCutter_%E1%84%89%E1%85%A2%E1%86%BA%E1%84%87%E1%85%A7%E1%86%AF(Daystar)-Sugar%20Cookie.mp3",
        boss: "https://file.garden/aWe99vhwaGcNwkok/%E6%B6%88%E6%B6%88%E6%A8%82/%E3%81%95%E3%82%8A%E3%81%84%EF%BC%BF%E3%81%BD%E3%82%93%E3%81%BD%E3%82%93%E4%BD%9C%E6%A5%AD%E6%97%A5%E5%92%8C%20.mp3",
        fever: "https://file.garden/aWe99vhwaGcNwkok/%E6%B6%88%E6%B6%88%E6%A8%82/%E3%81%BD%E3%81%A3%E3%81%B7%E3%81%99%E3%81%9F%E3%83%BC.mp3",
        match: "https://file.garden/aWe99vhwaGcNwkok/%E6%B6%88%E6%B6%88%E6%A8%82/%E6%B1%BA%E5%AE%9A%E3%83%9C%E3%82%BF%E3%83%B3%E3%82%92%E6%8A%BC%E3%81%9942.mp3",
        skill: "https://file.garden/aWe99vhwaGcNwkok/%E6%B6%88%E6%B6%88%E6%A8%82/%E6%B1%BA%E5%AE%9A%E3%83%9C%E3%82%BF%E3%83%B3%E3%82%92%E6%8A%BC%E3%81%9915.mp3",
        swapFail: "https://file.garden/aWe99vhwaGcNwkok/%E6%B6%88%E6%B6%88%E6%A8%82/%E6%B1%BA%E5%AE%9A%E3%83%9C%E3%82%BF%E3%83%B3%E3%82%92%E6%8A%BC%E3%81%9939.mp3",
        shuffle: "https://file.garden/aWe99vhwaGcNwkok/%E6%B6%88%E6%B6%88%E6%A8%82/%E6%B1%BA%E5%AE%9A%E3%83%9C%E3%82%BF%E3%83%B3%E3%82%92%E6%8A%BC%E3%81%9912.mp3",
        bomb: "https://file.garden/aWe99vhwaGcNwkok/%E6%B6%88%E6%B6%88%E6%A8%82/%E6%B1%BA%E5%AE%9A%E3%83%9C%E3%82%BF%E3%83%B3%E3%82%92%E6%8A%BC%E3%81%9916.mp3",
        levelUp: "https://file.garden/aWe99vhwaGcNwkok/%E6%B6%88%E6%B6%88%E6%A8%82/%E6%B1%BA%E5%AE%9A%E3%83%9C%E3%82%BF%E3%83%B3%E3%82%92%E6%8A%BC%E3%81%9929.mp3"
    };

    const SFX = {
        match: new Audio(AUDIO_SRC.match),
        skill: new Audio(AUDIO_SRC.skill),
        swapFail: new Audio(AUDIO_SRC.swapFail),
        shuffle: new Audio(AUDIO_SRC.shuffle),
        bomb: new Audio(AUDIO_SRC.bomb),
        levelUp: new Audio(AUDIO_SRC.levelUp)
    };
    
    const BGM = new Audio(AUDIO_SRC.bgm);
    BGM.loop = true;
    BGM.volume = 0.4; // ç¨å¾®å°è²ä¸€é»ä»¥å…åµé›œ

    const BOSS_BGM = new Audio(AUDIO_SRC.boss);
    BOSS_BGM.loop = true;
    BOSS_BGM.volume = 0.5;

    const FEVER_BGM = new Audio(AUDIO_SRC.fever);
    FEVER_BGM.loop = true;
    FEVER_BGM.volume = 0.5;

    function playSound(name) {
        if (SFX[name]) {
            SFX[name].currentTime = 0;
            SFX[name].play().catch(() => {}); // å¿½ç•¥è‡ªå‹•æ’­æ”¾é™åˆ¶éŒ¯èª¤
        }
    }

    // --- 1. è§’è‰²è³‡æ–™åº« (åŒ…å«æ€§æ ¼ä¿®æ­£å°è©) ---
    const CHAR_DB = {
        'venator': { 
            name: 'ç¶­ç´æ‰˜', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E7%B6%AD%E7%B4%8D%E6%89%98.png', type: 'color', synergy: ['narcissus'],
            quotes: { match: ['è®šç¾æœ¬ç‹ï¼', 'å“¼ï¼Œé€™é»å°äº‹ã€‚', 'æœ¬ç‹çš„é çŸ¥æ²’éŒ¯ã€‚', 'åˆ¥æ“‹è·¯ã€‚', 'çœ‹æ¸…æ¥šäº†ã€‚'], skill: ['è½æœ¬ç‹è™Ÿä»¤ï¼', 'å…¨é«”æ¶ˆé™¤ï¼', 'é€™å°±æ˜¯ç‹çš„åŠ›é‡ï¼'], item: ['å—¯ï¼Ÿæœ‰è¶£çš„ç™¼æ˜ã€‚', 'å‘ˆä¸Šä¾†å§ã€‚'] },
            synergy_quotes: ['ç´å¸Œç‘Ÿæ–¯ï¼Œè·Ÿä¸Šï¼', 'å±•ç¾æˆ‘å€‘çš„é»˜å¥‘å§ï¼'],
            boss_quotes: { 
                intro: 'æœ¬ç‹å°‡è¦ªè‡ªæˆç‚ºä½ å€‘çš„è©¦ç…‰ï¼',
                attack: ['æ„Ÿå—æœ¬ç‹çš„å¨å…‰ï¼', 'åœ¨æœ¬ç‹çš„é çŸ¥ä¸­ï¼Œä½ å€‘å·²ç¶“è¼¸äº†ã€‚', 'è·ªä¸‹ï¼'],
                defeat: 'å“¼...æœ‰é»æ„æ€...'
            }
        },
        'narcissus': { 
            name: 'ç´å¸Œç‘Ÿæ–¯', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E7%B4%8D%E5%B8%8C%E7%91%9F%E6%96%AF.png', type: 'convert', synergy: ['venator'],
            quotes: { match: ['ç‚ºäº†ç¶­ç´æ‰˜å…ˆç”Ÿï¼', 'è¬¹æ…è¡Œå‹•ã€‚', 'æ’é™¤éšœç¤™ã€‚', 'æˆ‘æœƒè™•ç†å¥½çš„ã€‚', 'åˆ¥æƒ³é è¿‘ã€‚'], skill: ['çœ‹è‘—æˆ‘çš„çœ¼ç›...', 'éƒ½è®Šæˆæˆ‘å§ï¼', 'æ²‰é†‰æ–¼æ­¤å§ã€‚'], item: ['ç‚ºäº†ä¿è­·...', 'é€™æ˜¯å¿…è¦çš„ã€‚'] },
            synergy_quotes: ['æ˜¯çš„ï¼Œç¶­ç´æ‰˜å…ˆç”Ÿï¼', 'ç‚ºäº†æ‚¨çš„æ¦®è€€ï¼']
        },
        'ora': { 
            name: 'å¥§æ‹‰', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E5%A5%A7%E6%8B%89.png', type: 'cross',
            quotes: { match: ['éº»ç…©æ­»äº†ã€‚', 'å˜–ã€‚', 'åˆ¥æµªè²»æ™‚é–“ã€‚', 'å¿«é»ã€‚', 'ç„¡èŠã€‚'], skill: ['è‚…æ¸…é–‹å§‹ã€‚', 'æ™‚é–“ï¼Œåœæ­¢å§ã€‚', 'çµ‚çµã€‚'], item: ['å¿«é»çµæŸã€‚', 'éš¨ä¾¿å•¦ã€‚'] },
            boss_quotes: { 
                intro: 'çµ‚æ–¼ä¾†äº†ï¼ŒçœŸå¤ æ…¢çš„ã€‚',
                attack: ['æ¶ˆå¤±å§ã€‚', 'çœŸæ˜¯ç¤™çœ¼ã€‚', 'æ™‚é–“åˆ°äº†ã€‚'],
                defeat: 'å˜–ï¼Œæµªè²»æ™‚é–“ã€‚'
            }
        },
        'melas': { 
            name: 'èœœæ‹‰æ€', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E8%9C%9C%E6%8B%89%E6%80%9D.png', type: 'random',
            quotes: { match: ['å“å‘€ï¼ŒçœŸæœ‰è¶£ï½', 'å‘µå‘µã€‚', 'æˆ‘å¾ˆæƒœå‘½çš„ã€‚', 'åˆ¥å¼„é«’æˆ‘çš„è¡£æœã€‚', 'å¥½ç©å—ï¼Ÿ'], skill: ['çµ¦ä½ å€‘ä¸€é»å°è©›å’’ï½', 'çœ‹æˆ²æ™‚é–“çµæŸå›‰ã€‚', 'å„é‹é™è‡¨ï½'], item: ['é€™æ±è¥¿å®‰å…¨å—ï¼Ÿ', 'é€çµ¦ä½ ï½'] },
            boss_quotes: { 
                intro: 'å‘µå‘µï¼Œä¾†é™ªæˆ‘ç©ç©å§ï¼Ÿ',
                attack: ['çµ¦ä½ ä¸€é»å°å°çš„è©›å’’ï½', 'å‘µå‘µï¼Œé€ƒä¸æ‰çš„ã€‚', 'è®Šå¾—æ›´æœ‰è¶£ä¸€é»å§ï½'],
                defeat: 'å“å‘€ï¼Œè¢«ä½ å€‘ç ´è§£äº†å‘¢ã€‚'
            }
        },
        'manmu': { 
            name: 'å°ç›®', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E5%B0%8F%E7%9B%AE.png', type: 'row', synergy: ['lynn'],
            quotes: { match: ['å¯¶è²ä½ çœ‹ï¼æˆ‘å²å®³å§ï¼', 'æˆ‘æ˜¯æœ€æ£’çš„ç¸½è£ï¼', 'å¤©æ¶¼äº†...', 'é€™å°±æ˜¯å¯¦åŠ›ï¼', 'è³ºç¿»äº†ï¼'], skill: ['é€šé€šè®Šæˆæˆ‘çš„è³‡ç”¢ï¼', 'é–ƒäº®ç™»å ´âœ¨ï¼', 'æ”¶è³¼ï¼'], item: ['é€™å€‹å€¼å¤šå°‘éŒ¢ï¼Ÿ', 'è²·ä¸‹ä¾†ï¼'] },
            synergy_quotes: ['æ—æ©ï¼å¿«è¨˜ä¸‹ä¾†ï¼', 'é€™æ³¢æ“ä½œå¾ˆè³ºå§ï¼']
        },
        'mollie': { 
            name: 'èŒ‰è‰', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E8%8C%89%E8%8E%89.png', type: 'boost',
            quotes: { match: ['è¦åŠ ç­äº†å—...', 'å”‰...', 'æˆ‘çš„èŠ’æœçœŸå¯æ„›ã€‚', 'å¥½æƒ³ç¡...', 'ä¸è¦å—å‚·å–”ã€‚'], skill: ['æ‰“èµ·ç²¾ç¥ä¾†ï¼', 'è£œå……èƒ½é‡ï¼', 'æ²»ç™‚æ™‚é–“ã€‚'], item: ['é€™æ˜¯é†«ç™‚å™¨æå—ï¼Ÿ', 'å°å¿ƒä½¿ç”¨ã€‚'] }
        },
        'virdrakos': { 
            name: 'è˜­è˜­', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E8%98%AD%E8%98%AD.png', type: 'area',
            quotes: { match: ['å“‡å“ˆå“ˆï¼è˜­è˜­æ˜¯æœ€å¼·çš„å‘€ï¼', 'èª°æ•¢æ“‹è˜­è˜­å‘€ï¼Ÿ', 'éŒ¢æ‹¿ä¾†å‘€ï¼', 'ç‡’æˆç°ç‡¼å‘€ï¼', 'æ€•äº†å§ï¼Ÿ'], skill: ['åƒæˆ‘ä¸€è¨˜é¾ä¹‹åæ¯å‘€ï¼', 'å…¨éƒ¨ç‡’èµ·ä¾†å‘€ï¼', 'é¾ç‚çˆ†ç™¼å‘€ï¼'], item: ['é€™å€‹å¥½ç©ï¼çµ¦æˆ‘å‘€ï¼', 'äº®æ™¶æ™¶çš„ï¼'] }
        },
        'jornona': { 
            name: 'å–¬è«¾å¨œ', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E5%96%AC%E8%AB%BE%E5%A8%9C.png', type: 'color',
            quotes: { match: ['å•¦å•¦å•¦ï½', 'æœ‰æ«»æ¡ƒåƒå—ï¼Ÿ', 'è˜­è˜­å¥½å¸¥ï½', 'ä¸€èµ·è·³èˆå§ï¼', 'éŸ³æ¨‚èµ·ï¼'], skill: ['è½æˆ‘å”±æ­Œå§ï¼', 'é–‹æ´¾å°å›‰ï¼', 'é«˜éŸ³æ”»æ“Šï¼'], item: ['é€™å€‹å¯ä»¥ç•¶éº¥å…‹é¢¨å—ï¼Ÿ', 'å¥½é–ƒäº®ï¼'] }
        },
        'kleion': { 
            name: 'å…‹é‡Œæ˜‚', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E5%85%8B%E9%87%8C%E6%98%82.png', type: 'col',
            quotes: { match: ['æ­£ç¾©å¿…å‹ï¼', 'ä¾†é‹å‹•å§ï¼', 'æˆ‘æ˜¯ç›´ç”·ã€‚', 'ç‡ƒç‡’è„‚è‚ªï¼', 'å…¨åŠ›ä»¥èµ´ï¼'], skill: ['è¡é‹’é™·é™£ï¼', 'é€™å°±æ˜¯åŒ–å­¸åæ‡‰ï¼', 'çªç ´æ¥µé™ï¼'], item: ['é€™ä¸ç§‘å­¸ã€‚', 'å¯¦é©—å™¨æï¼Ÿ'] }
        },
        'costa': { 
            name: 'ç§‘çµ²å¡”', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E7%A7%91%E7%B5%B2%E5%A1%94.png', type: 'cross',
            quotes: { match: ['BATA...', 'çœŸæ˜¯å¥‡æ€ªã€‚', 'æˆ‘æœƒåŠ æ²¹çš„BATAï¼', 'ä¸è¦éä¾†BATAã€‚', 'å¥½ç†±BATA...'], skill: ['é›–ç„¶ä¸æ‡‚ä½†æ„Ÿè¦ºå¾ˆå²å®³BATAï¼', 'è¦èåŒ–äº†BATA...', 'å²èŠå§†è¡æ“ŠBATAï¼'], item: ['é€™æ˜¯ä»€éº¼BATAï¼Ÿ', 'å¯ä»¥åƒå—BATAï¼Ÿ'] }
        },
        'james': { 
            name: 'å°é›…å„', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E5%B0%8F%E9%9B%85%E5%90%84.png', type: 'cross', synergy: ['andreas'],
            quotes: { match: ['...', '(æ‘©æ–¯é›»ç¢¼: åª½çš„)', 'å¥½æƒ³åƒæ©˜å­...', '...', '(é„™è¦–çš„çœ¼ç¥)'], skill: ['(é«˜å£“é›»æ“Šç™¼å°„ï¼)', 'å—¶å“©å—¶å“©â€”â€”ï¼', '...ï¼'], item: ['(å¥½å¥‡åœ°çœ‹è‘—é“å…·)', '...'] },
            synergy_quotes: ['(æŒ‡è‘—å‰æ–¹)', '... (é»é ­)']
        },
        'andreas': { 
            name: 'å®‰å¾·çƒˆ', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E5%AE%89%E5%BE%B7%E7%83%88.png', type: 'col', synergy: ['james'],
            quotes: { match: ['å ±å‘Šï¼ç™¼ç¾ç›®æ¨™ã€‚', 'å°é›…å„...', 'æ©Ÿæ¢°é‹ä½œæ­£å¸¸ã€‚', 'åŸ·è¡ŒæŒ‡ä»¤ã€‚', 'æ’é™¤å¨è„…ã€‚'], skill: ['å¤–éª¨éª¼å…¨åŠŸç‡è¼¸å‡ºã€‚', 'ä¿®æ­£éŒ¯èª¤ã€‚', 'æ®²æ»…æ¨¡å¼ã€‚'], item: ['å ±å‘Šï¼ç”³è«‹ä½¿ç”¨é“å…·ã€‚', 'è£å‚™ç¢ºèªã€‚'] },
            synergy_quotes: ['å°é›…å„ï¼Œç¢ºèªç›®æ¨™ï¼', 'åˆé«”æ”»æ“Šæ¨¡å¼å•Ÿå‹•ã€‚']
        },
        'peter': { 
            name: 'å½¼å¾—', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E5%BD%BC%E5%BE%97.png', type: 'area', synergy: ['lynn'],
            quotes: { match: ['é›¢æˆ‘é é»ã€‚', 'è²“è²“ï¼', 'Shitã€‚', 'åˆ¥ç¢°æˆ‘ã€‚', 'çœŸå€’æ¥£ã€‚'], skill: ['é©…æ•£é‚ªéˆï¼', 'é€™è£¡å¤ªé«’äº†ã€‚', 'è–å…‰å•Šï¼'], item: ['é€™æ±è¥¿å‰ç¥¥å—ï¼Ÿ', 'å˜–ã€‚'] },
            synergy_quotes: ['æ—æ©ï¼Œåˆ¥ç®—è¨ˆæˆ‘ï¼', 'å¿«é»æå®šå®ƒï¼']
        },
        'lynn': { 
            name: 'æ—æ©', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E6%9E%97%E6%81%A9.png', type: 'boost', synergy: ['peter', 'manmu'],
            quotes: { match: ['æ¶¼æ‹Œã€‚', 'æœ‰éŒ¢è³ºå—ï¼Ÿ', 'å½¼å¾—é–‰å˜´ã€‚', 'æ•ˆç‡å¤ªä½äº†ã€‚', 'åŠ ç­è²»ç…§ç®—ã€‚'], skill: ['é€™å°±æ˜¯å•†æ¥­æ‰‹æ®µã€‚', 'æ•ˆç‡æå‡ã€‚', 'é ç®—æ‰¹å‡†ã€‚'], item: ['æˆæœ¬å¤šå°‘ï¼Ÿ', 'é€™èƒ½æŠµç¨…å—ï¼Ÿ'] },
            synergy_quotes: ['å½¼å¾—ï¼Œå·¥ä½œäº†ã€‚', 'ç¸½è£ï¼Œè«‹çœ‹é€™é‚Šã€‚']
        },
        'novian': { 
            name: 'è«¾ç¶­å®‰', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E8%AB%BE%E7%B6%AD%E5%AE%89.png', type: 'col', synergy: ['noran'],
            quotes: { match: ['ä»Šå¤©å¤©æ°£çœŸå¥½ï¼', 'æˆ‘æ˜¯èˆ¹é•·ï¼', 'å¤§å®¶è¦å¥½å¥½ç›¸è™•å–”ï¼', 'å‡ºç™¼å›‰ï¼', 'å¤§æµ·åœ¨å‘¼å–šï¼'], skill: ['é€™æ¢èˆªç·šæ²’å•é¡Œï¼', 'å…¨é€Ÿå‰é€²ï¼', 'æšå¸†ï¼'], item: ['é€™å€‹å¥½åƒå¾ˆæœ‰ç”¨ï¼', 'å¯¶è—å—ï¼Ÿ'] },
            synergy_quotes: ['è«¾éƒï¼Œä¸€èµ·ä¾†ï¼', 'å…„å¼Ÿé½Šå¿ƒï¼']
        },
        'caroline': { 
            name: 'å¡æ´›ç‰¹', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E5%8D%A1%E6%B4%9B%E7%89%B9.png', type: 'random',
            quotes: { match: ['é€™å¾ˆå‹å–„ã€‚', 'å—¶å—¶â€”â€”æ”¶åˆ°è¨Šè™Ÿã€‚', 'é€™ä¸å‹å–„ï¼(å°–å«)', 'é€£ç·šä¸­...', 'è³‡æ–™å‚³è¼¸ã€‚'], skill: ['é›»æ³¢å¹²æ“¾...é–‹å§‹ã€‚', 'é€£ç·šä¸­æ–·ã€‚', 'ç³»çµ±éŒ¯èª¤ã€‚'], item: ['ä¸æ˜ç‰©é«”æª¢æ¸¬ä¸­ã€‚', 'åˆ†ææˆåˆ†ã€‚'] }
        },
        'estrella': { 
            name: 'æ˜Ÿæ˜Ÿ', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E6%98%9F%E6%98%9F.png', type: 'area',
            quotes: { match: ['æˆ‘ä¾†å¹«å¿™äº†ï¼', 'æˆ‘æœ‰å¥½å¤šå€‹ï¼', 'æˆ‘è¦åƒæ±è¥¿ï¼', 'è®Šè®Šè®Šï¼', 'å¥½å¤šæ˜Ÿæ˜Ÿï¼'], skill: ['åˆ†è£‚â€”â€”ï¼', 'å˜¿å’»å˜¿å’»ï¼', 'æ˜Ÿæ˜Ÿæ”»æ“Šï¼'], item: ['é€™å€‹å¯ä»¥åƒå—ï¼Ÿ', 'å¥½é¦™å–”ï¼'] }
        },
        'poseidon': { 
            name: 'æµ·ç¥', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E6%B5%B7%E7%A5%9E.png', type: 'color', synergy: ['hades'],
            quotes: { match: ['å¤©å¤©é–‹å¿ƒï¼', 'è¡å•Šï¼ï¼', 'å¤§é»‘ä½ çœ‹ï¼', 'æ¸¸æ³³å›‰ï¼', 'æ°´èŠ±å››æ¿ºï¼'], skill: ['å¤§æµªä¾†å•¦ï¼', 'å“ˆå“ˆå“ˆå“ˆï¼', 'å¤§æµ·å˜¯ï¼'], item: ['é€™æ˜¯ä»€éº¼å¥½ç©çš„ï¼Ÿ', 'çµ¦å¤§é»‘çœ‹ï¼'] },
            synergy_quotes: ['å¤§é»‘ï¼ä¸€èµ·ç©ï¼', 'æˆ‘å€‘æ˜¯æœ€å¼·çš„ï¼']
        },
        'hades': { 
            name: 'å†¥ç¥', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E5%86%A5%E7%A5%9E.png', type: 'random', synergy: ['poseidon'],
            quotes: { match: ['...', 'æµ·ç¥...', 'æœ‰é»äº®ã€‚', 'åµæ­»äº†ã€‚', '...'], skill: ['...å®‰éœã€‚', '...æ¶ˆå¤±ã€‚', 'å†¥ç•Œä¹‹é–€ã€‚'], item: ['...', 'ç„¡èŠã€‚'] },
            synergy_quotes: ['...æµ·ç¥ï¼Œåˆ¥é¬§ã€‚', '...åƒ…æ­¤ä¸€æ¬¡ã€‚'],
            boss_quotes: { 
                intro: '...',
                attack: ['...å®‰éœã€‚', '...æ­¸æ–¼ç„¡ã€‚', '...'],
                defeat: '...æµ·ç¥...'
            }
        },
        'noran': { 
            name: 'è«¾éƒ', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E8%AB%BE%E9%83%8E.png', type: 'area', synergy: ['novian'],
            quotes: { match: ['...åˆ¥çœ‹æˆ‘ã€‚', 'ç…©æ­»äººäº†ã€‚', 'é›¢è«¾ç¶­å®‰é é»ã€‚', 'æ»¾é–‹ã€‚', 'å˜–ã€‚'], skill: ['æˆ‘è¦è·Ÿä½ ä¸€èµ·çˆ†äº†ã€‚', 'å…¨éƒ¨ç‚¸é£›ã€‚', 'æ¯€æ»…å§ã€‚'], item: ['å“¼ï¼Œå‹‰å¼·ç”¨ä¸€ä¸‹ã€‚', 'é€™ä»€éº¼åƒåœ¾ã€‚'] },
            synergy_quotes: ['è«¾ç¶­å®‰ï¼Œèº²å¥½ã€‚', 'èª°æ•¢å‹•ä»–ï¼']
        },
        'joruuna': { 
            name: 'è˜‡éƒ', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E8%98%87%E9%83%8E.png', type: 'row', synergy: ['hassel'],
            quotes: { match: ['å“ˆå“ˆã€‚', 'éš¨ä¾¿å§ã€‚', 'ä¸‹ç­äº†å—ï¼Ÿ', 'å¥½ç´¯å–”ã€‚', 'å¯ä»¥èµ°äº†å—ï¼Ÿ'], skill: ['åˆ¥æ‰“æ“¾æˆ‘ä¼‘æ¯ã€‚', 'å¾®ç¬‘é¢å°ã€‚', 'å†è¦‹å›‰ã€‚'], item: ['å“ˆè˜‡æ²’æ•™éé€™å€‹ã€‚', 'éš¨ä¾¿ç”¨ç”¨ã€‚'] },
            synergy_quotes: ['å“ˆè˜‡ï¼Œäº¤çµ¦ä½ äº†ã€‚', 'æˆ‘å€‘é€Ÿæˆ°é€Ÿæ±ºå§ã€‚']
        },
        'nathanael': { 
            name: 'æ‹¿ä½†æ¥­', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E6%8B%BF%E4%BD%86%E6%A5%AD.png', type: 'random', synergy: ['philippos'],
            quotes: { match: ['å¥½ç´¯...', 'ç‰›æ’...', 'ä¸æƒ³å‹•ã€‚', 'å¯ä»¥ç¡è¦ºå—ï¼Ÿ', 'å¥½é¤“...'], skill: ['ç¨å¾®...å‹•ä¸€ä¸‹å§ã€‚', 'çœŸéº»ç…©ã€‚', 'çµæŸäº†å—ï¼Ÿ'], item: ['è…“åŠ›ï¼Œå¹«æˆ‘æ‹¿é€™å€‹ã€‚', 'å¥½é‡...'] },
            synergy_quotes: ['è…“åŠ›ï¼Œä¸Šå§ã€‚', 'æˆ‘æ©è­·ä½ ...å¤§æ¦‚ã€‚']
        },
        'philippos': { 
            name: 'è…“åŠ›', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E8%85%93%E5%8A%9B.png', type: 'area', synergy: ['nathanael'],
            quotes: { match: ['å°‘ä¸»ï¼', 'æˆ‘çœ‹è¦‹è²“äº†ï¼', 'å–ï¼', 'å……æ»¿åŠ›é‡ï¼', 'ç‚ºäº†å°‘ä¸»ï¼'], skill: ['ä¿è­·å°‘ä¸»ï¼', 'åƒæˆ‘ä¸€æ‹³ï¼', 'å…¨åŠ›å…¨é–‹ï¼'], item: ['å°‘ä¸»é€™å€‹å¥½å²å®³ï¼', 'æˆ‘ä¾†è©¦è©¦ï¼'] },
            synergy_quotes: ['å°‘ä¸»ï¼æˆ‘ä¾†äº†ï¼', 'çµ•ä¸è®“ä»»ä½•äººå‚·å®³å°‘ä¸»ï¼']
        },
        'lilith': { 
            name: 'è‰è‰çµ²', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E8%8E%89%E8%8E%89%E6%96%AF.png', type: 'convert', synergy: ['adorabilis'],
            quotes: { match: ['æƒ³å–èŒ¶äº†ï½', 'é˜¿æœµæ‹‰ï½', 'çœŸç„¡èŠã€‚', 'é™ªæˆ‘ç©å˜›ã€‚', 'å‘µå‘µã€‚'], skill: ['è½è©±ï½', 'éƒ½è®Šæˆæˆ‘çš„å­©å­å§ã€‚', 'ä¹–å­©å­ã€‚'], item: ['é€çµ¦é˜¿æœµæ‹‰å¥½äº†ã€‚', 'é€™ä»€éº¼ï¼Ÿ'] },
            synergy_quotes: ['é˜¿æœµæ‹‰ï¼Œéä¾†ï½', 'æˆ‘å€‘ä¸€èµ·ç©å§ã€‚']
        },
        'adorabilis': { 
            name: 'é˜¿æœµæ‹‰', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E9%98%BF%E6%9C%B5%E6%8B%89.png', type: 'cross', synergy: ['lilith'],
            quotes: { match: ['è‰è‰çµ²ï¼', 'æˆ‘çš„å­©å­å‘¢ï¼Ÿ', 'è¨å­å°å·ï¼', 'é‚„çµ¦æˆ‘ï¼', 'å‰ªåˆ€...'], skill: ['ä¹–å­©å­ï½', 'ç¸«èµ·ä¾†å§ã€‚', 'å‰ªæ–·ï¼'], item: ['å¯ä»¥ç”¨ä¾†åšäººå¶å—ï¼Ÿ', 'é‡ç·š...'] },
            synergy_quotes: ['è‰è‰çµ²...å–œæ­¡ã€‚', 'ä¸€èµ·...ç¸«èµ·ä¾†ã€‚']
        },
        'lazar': { 
            name: 'æ‹‰æ‰çˆ¾', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E6%8B%89%E6%89%8E%E7%88%BE.png', type: 'boost', 
            quotes: { match: ['çœŸæ˜¯å€‹å¥½å­©å­ã€‚', 'è¦è½æ•…äº‹å—ï¼Ÿ', 'å‘µå‘µã€‚', 'åˆ¥æ€¥åˆ¥æ€¥ã€‚', 'æ…¢æ…¢ä¾†ã€‚'], skill: ['ç—›ç—›é£›èµ°å›‰ã€‚', 'å¤§å®¶åŠ æ²¹ã€‚', 'ç¥ç¦ä½ å€‘ã€‚'], item: ['å°å¿ƒä½¿ç”¨å–”ã€‚', 'é€™æ˜¯ç¦®ç‰©ã€‚'] }
        },
        'hassel': { 
            name: 'å“ˆè˜‡', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E5%93%88%E8%98%87.png', type: 'col', synergy: ['joruuna'],
            quotes: { match: ['æˆ‘æœ‰è¨˜ã€‚', 'é€™ä¸åœ¨è¨ˆç•«å…§ã€‚', 'è˜‡éƒï¼Ÿ', 'é•è¦ã€‚', 'è¨˜éŒ„ä¸­ã€‚'], skill: ['è¨˜éŒ„æ¶ˆé™¤ã€‚', 'æŒ‰ç…§è¦çŸ©ä¾†ã€‚', 'ä¿®æ­£ã€‚'], item: ['é€™æˆ‘ä¹Ÿè¦è¨˜ä¸‹ä¾†ã€‚', 'å­˜æª”ã€‚'] },
            synergy_quotes: ['è˜‡éƒï¼Œåˆ¥å·æ‡¶ã€‚', 'åŸ·è¡Œå”åŒä½œæˆ°ã€‚']
        },
        'cousin': { 
            name: 'è¡¨å“¥', img: 'https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E8%A1%A8%E5%93%A5.png', type: 'area',
            quotes: { match: ['è€å­ç½©ä½ ï¼', 'è¡¨å¼Ÿï¼', 'é…·å§ï¼Ÿ', 'å¸¥ä¸å¸¥ï¼Ÿ', 'çœ‹æˆ‘çš„ï¼'], skill: ['çœ‹è€å­çš„ï¼', 'èª°æ•¢å‹•æˆ‘å¼Ÿå¦¹ï¼', 'è¶…æ´¾ï¼'], item: ['é€™ç©æ„æŒºæ½®çš„ã€‚', 'æ‹¿å»ç©ï¼'] }
        }
    };

    // æŠ€èƒ½èªªæ˜æ–‡æœ¬
    const SKILL_DESC = {
        'random': 'ã€éš¨æ©Ÿã€‘éš¨æ©Ÿæ¶ˆé™¤5å€‹', 'area': 'ã€çˆ†ç‚¸ã€‘æ¶ˆé™¤å‘¨åœä¹å®®æ ¼', 'cross': 'ã€åå­—ã€‘æ¶ˆé™¤åå­—ç¯„åœ',
        'color': 'ã€è™Ÿä»¤ã€‘æ¶ˆé™¤å ´ä¸Šæ‰€æœ‰åŒè‰²', 'row': 'ã€æ©«æƒã€‘æ¶ˆé™¤æ•´åˆ—', 'col': 'ã€è²«ç©¿ã€‘æ¶ˆé™¤æ•´è¡Œ',
        'convert': 'ã€åŒåŒ–ã€‘å°‡å‘¨åœè®Šç‚ºè‡ªå·±', 'boost': 'ã€æ‡‰æ´ã€‘å¤§å¹…å¢åŠ  Fever å€¼',
        'bomb_3x3': 'ã€çˆ†ç ´ã€‘æ¶ˆé™¤ 3x3 å€åŸŸ'
    };

    // --- æ£‹ç›¤å½¢ç‹€å®šç¾© ---
    const BOARD_SHAPES = {
        'rect': null,
        'cross': [
            [0,0,1,1,0,0], [0,1,1,1,1,0], [1,1,1,1,1,1], [1,1,1,1,1,1], [1,1,1,1,1,1],
            [1,1,1,1,1,1], [1,1,1,1,1,1], [0,1,1,1,1,0], [0,0,1,1,0,0]
        ],
        'donut': [
            [1,1,1,1,1,1], [1,1,1,1,1,1], [1,1,1,1,1,1],
            [1,1,0,0,1,1], [1,1,0,0,1,1], [1,1,0,0,1,1],
            [1,1,1,1,1,1], [1,1,1,1,1,1], [1,1,1,1,1,1]
        ],
        'hourglass': [
            [1,1,1,1,1,1], [0,1,1,1,1,0], [0,0,1,1,0,0],
            [0,0,0,0,0,0], [0,0,1,1,0,0], [0,0,1,1,0,0],
            [0,1,1,1,1,0], [1,1,1,1,1,1], [1,1,1,1,1,1]
        ]
    };

    // --- 2. éŠæˆ²è®Šæ•¸èˆ‡ DOM (Globals) ---
    const COLS = 6;
    const ROWS = 9;
    let grid = [];
    let activeCharKeys = [];
    let comboCount = 0;
    
    // å­˜æª”èˆ‡ç‹€æ…‹
    let gameState = { level: 1, totalScore: 0, unlockedChars: [], charLevels: {}, isRandomTeam: true, selectedTeam: [] };
    let currentLevelScore = 0;
    let targetScore = 1000;
    let isProcessing = false;
    let activeProp = null;
    let activeInputTile = null;
    let startX, startY;
    let isPaused = false;

    // Fever ç³»çµ±è®Šæ•¸
    let feverValue = 0;
    const MAX_FEVER = 100;
    let isFeverTime = false;
    let feverTimer = null;
    
    // BOSS æˆ°ç³»çµ±è®Šæ•¸
    let isBossLevel = false;
    let bossMaxHP = 0;
    let bossCurrentHP = 0;
    let bossAttackCounter = 0;
    let currentBossAttackThreshold = 8; 
    let isBossBerserk = false;
    let currentPlayingBGM = BGM;
    let currentBossKey = null;

    // é“å…·ç‹€æ…‹
    let props = { bomb: 3, lightning: 3, shuffle: 3 };

    // DOM Selection
    const gridEl = document.getElementById('grid');
    const vfxEl = document.getElementById('vfx-layer');
    const dialogueBubble = document.getElementById('dialogue-bubble');
    const dName = document.getElementById('d-name');
    const dText = document.getElementById('d-text');
    const dImg = document.getElementById('d-img');

    // æ¥ä¸‹ä¾†æ˜¯ Part 3 (éŠæˆ²æ ¸å¿ƒé‚è¼¯)
    // --- 3. åˆå§‹åŒ–èˆ‡å­˜æª” (Init & Save) ---
    window.onload = function() {
        // å•Ÿå‹• Fever è¡°é€€è¨ˆæ™‚å™¨
        setInterval(() => {
            if (isPaused) return;
            if (!isFeverTime && feverValue > 0) {
                feverValue = Math.max(0, feverValue - 2); updateUI();
            }
        }, 1000);
        loadData();
    };

    function loadData() {
        const saved = localStorage.getItem('party_game_save_final');
        if (saved) gameState = JSON.parse(saved);
        if (!gameState.unlockedChars) gameState.unlockedChars = [];
        if (!gameState.charLevels) gameState.charLevels = {};
        if (gameState.isRandomTeam === undefined) gameState.isRandomTeam = true;
        if (!gameState.selectedTeam) gameState.selectedTeam = [];
        document.getElementById('title-level').innerText = gameState.level;
    }

    function saveData() {
        localStorage.setItem('party_game_save_final', JSON.stringify(gameState));
    }

    function startGame() {
        // å˜—è©¦æ’­æ”¾ BGM (éœ€ä½¿ç”¨è€…äº’å‹•)
        BGM.play().catch(() => console.log("BGM start requires interaction"));
        document.getElementById('title-screen').style.display = 'none';
        initLevel();
    }
    function resetGameData() {
    // è·³å‡ºç¢ºèªè¦–çª—ï¼Œé¿å…èª¤æŒ‰
    if(confirm("ç¢ºå®šè¦åˆªé™¤å­˜æª”ä¸¦é‡ç½®ç­‰ç´šå—ï¼Ÿ\n(æ­¤å‹•ä½œç„¡æ³•å¾©åŸ)")) {
        // æ¸…é™¤ç€è¦½å™¨å…§çš„å­˜æª”
        localStorage.removeItem('party_game_save_final');
        
        // é‡æ–°æ•´ç†ç¶²é ï¼Œè®“éŠæˆ²é‡æ–°è®€å–åˆå§‹ç‹€æ…‹
        location.reload(); 
    }
}

function togglePause() {
    isPaused = !isPaused;
    const overlay = document.getElementById('pause-overlay');
    overlay.style.display = isPaused ? 'flex' : 'none';

    if (isPaused) {
        // æš«åœéŸ³æ¨‚
        currentPlayingBGM.pause();
        FEVER_BGM.pause();
    } else {
        // æ¢å¾©éŸ³æ¨‚
        if (isFeverTime) FEVER_BGM.play().catch(()=>{});
        else currentPlayingBGM.play().catch(()=>{});
    }
}

function backToTitle() {
    isPaused = false;
    document.getElementById('pause-overlay').style.display = 'none';
    document.getElementById('title-screen').style.display = 'flex';
    
    // åœæ­¢æ‰€æœ‰éŸ³æ¨‚
    BGM.pause(); BGM.currentTime = 0;
    BOSS_BGM.pause(); BOSS_BGM.currentTime = 0;
    FEVER_BGM.pause(); FEVER_BGM.currentTime = 0;
}

    function initLevel() {
        isBossLevel = (gameState.level > 0 && gameState.level % 5 === 0);
        document.body.classList.toggle('boss-level', isBossLevel);
        document.body.classList.remove('boss-berserk');
        isBossBerserk = false;

        // é‡ç½®é“å…·æ•¸é‡ (æ¯é—œè£œæ»¿ï¼Œå¢åŠ çˆ½åº¦)
        props = { bomb: 3, lightning: 3, shuffle: 3 };
        updatePropUI();

        let config;
        if (isBossLevel) {
            // BOSS é—œå¡é…ç½®
            document.getElementById('normal-progress').style.display = 'none';
            document.getElementById('boss-hp-container').style.display = 'block';
            document.getElementById('boss-container').style.display = 'block';
            
            bossMaxHP = 1500 + (gameState.level * 250);
            bossCurrentHP = bossMaxHP;
            bossAttackCounter = 0;
            // BOSS æ”»æ“Šé »ç‡éš¨ç­‰ç´šå¢åŠ  (æœ€å¿«æ¯ 3 æ¬¡æ¶ˆé™¤æ”»æ“Šä¸€æ¬¡)
            currentBossAttackThreshold = Math.max(3, 6 - Math.floor(gameState.level / 5));
            
            const bossKeys = Object.keys(CHAR_DB);
            currentBossKey = bossKeys[Math.floor(Math.random() * bossKeys.length)];
            const bossData = CHAR_DB[currentBossKey];
            document.getElementById('boss-img').src = bossData.img;

            updateBossUI();

            config = {
                target: bossMaxHP, // ç›®æ¨™å°±æ˜¯BOSSçš„è¡€é‡
                ice: 5 + Math.floor(gameState.level / 10) * 2, // BOSSé—œåˆå§‹å†°å¡Š
                stone: Math.floor(gameState.level / 5), // BOSSé—œåˆå§‹çŸ³é ­
                shape: 'rect'
            };
            
            // åˆ‡æ›éŸ³æ¨‚
            BGM.pause();
            FEVER_BGM.pause();
            currentPlayingBGM = BOSS_BGM;
            currentPlayingBGM.play().catch(()=>{});

        } else {
            // æ™®é€šé—œå¡é…ç½®
            document.getElementById('normal-progress').style.display = 'block';
            document.getElementById('boss-hp-container').style.display = 'none';
            document.getElementById('boss-container').style.display = 'none';
            
            config = LEVEL_CONFIG[gameState.level] || {
                target: 3000,
                ice: Math.min(20, 10 + Math.floor((gameState.level - 5))),
                stone: Math.min(10, Math.floor((gameState.level - 3) / 2)),
                shape: Object.keys(BOARD_SHAPES)[(gameState.level - 1) % Object.keys(BOARD_SHAPES).length]
            };

            // åˆ‡æ›éŸ³æ¨‚
            BOSS_BGM.pause();
            FEVER_BGM.pause();
            currentPlayingBGM = BGM;
            currentPlayingBGM.play().catch(()=>{});
        }

        targetScore = config.target;
        currentLevelScore = 0;
        
        // ç·¨éšŠé‚è¼¯
        if (gameState.isRandomTeam) {
            // éš¨æ©ŸæŠ½é¸ 7 ä½è§’è‰²
            activeCharKeys = Object.keys(CHAR_DB).sort(() => 0.5 - Math.random()).slice(0, 7);
        } else {
            // ä½¿ç”¨è‡ªé¸éšŠä¼
            activeCharKeys = [...gameState.selectedTeam];
            // å¦‚æœä¸è¶³ 7 äººï¼Œéš¨æ©Ÿè£œè¶³
            if (activeCharKeys.length < 7) {
                const remaining = Object.keys(CHAR_DB).filter(k => !activeCharKeys.includes(k));
                activeCharKeys = activeCharKeys.concat(remaining.sort(() => 0.5 - Math.random()).slice(0, 7 - activeCharKeys.length));
            }
        }
        
        // è§£é–è§’è‰²
        activeCharKeys.forEach(key => {
            if(!gameState.unlockedChars.includes(key)) gameState.unlockedChars.push(key);
        });
        saveData();

        updateUI();
        createGrid(config.ice, config.shape);
        
        // é–‹å ´å°è©±
        if (isBossLevel) {
            triggerDialogue(currentBossKey, 'boss_intro', `Lv.${gameState.level} BOSS ${CHAR_DB[currentBossKey].name} ä¾†è¥²ï¼`);
        } else {
            triggerDialogue(activeCharKeys[0], 'match', `ç¬¬ ${gameState.level} é—œï¼ç›®æ¨™ ${targetScore} åˆ†ï¼`);
        }
    }

    function createGrid(iceCount, stoneCount, shapeName) {
        gridEl.innerHTML = '';
        grid = [];
        const shape = BOARD_SHAPES[shapeName] || BOARD_SHAPES['rect'];

        for(let r=0; r<ROWS; r++) {
            grid[r] = [];
            for(let c=0; c<COLS; c++) {
                // æª¢æŸ¥å½¢ç‹€é®ç½©
                if(shape && shape[r] && shape[r][c] === 0) {
                    // å‰µå»ºéš±å½¢ä½”ä½ç¬¦
                    const el = document.createElement('div');
                    el.className = 'tile';
                    el.style.visibility = 'hidden';
                    gridEl.appendChild(el);
                    grid[r][c] = { r, c, type: null, el, isSkill: false, isFrozen: false, isStone: false, isVoid: true };
                    updateTilePos(grid[r][c], false);
                } else {
                    spawnTile(r, c, false);
                }
            }
        }
        
        // ç”Ÿæˆå†°å¡Šéšœç¤™
        let placedIce = 0;
        let attempts = 0;
        while(placedIce < iceCount && attempts < 100) {
            attempts++;
            let r = Math.floor(Math.random() * ROWS);
            let c = Math.floor(Math.random() * COLS);
            if(!grid[r][c].isVoid && !grid[r][c].isFrozen && !grid[r][c].isStone) {
                grid[r][c].isFrozen = true;
                grid[r][c].el.classList.add('frozen');
                placedIce++;
            }
        }

        // ç”ŸæˆçŸ³é ­éšœç¤™
        let placedStone = 0;
        attempts = 0;
        const targetStones = stoneCount || 0;
        while(placedStone < targetStones && attempts < 100) {
            attempts++;
            let r = Math.floor(Math.random() * ROWS);
            let c = Math.floor(Math.random() * COLS);
            if(!grid[r][c].isVoid && !grid[r][c].isFrozen && !grid[r][c].isStone) {
                grid[r][c].isStone = true;
                updateTileContent(grid[r][c]);
                placedStone++;
            }
        }

        // å»¶é²æ¶ˆé™¤åˆå§‹é€£ç·š (é¿å…é–‹å ´å°±ç‰¹æ•ˆäº‚é£›)
        setTimeout(resolveInitialMatches, 500); 
    }

    function resolveInitialMatches() {
        const matches = findMatches();
        if(matches.length > 0) {
            // åˆå§‹å¦‚æœæœ‰é€£ç·šï¼Œç›´æ¥å®‰éœåœ°é‡æ´—å°æ‡‰æ ¼å­
            matches.forEach(m => m.forEach(t => {
                if(t.isVoid) return;
                t.type = activeCharKeys[Math.floor(Math.random() * activeCharKeys.length)];
                updateTileContent(t);
            }));
            // éè¿´æª¢æŸ¥ç›´åˆ°æ²’æœ‰é€£ç·š
            resolveInitialMatches();
        }
    }

    function spawnTile(r, c, animate=true) {
        const type = activeCharKeys[Math.floor(Math.random() * activeCharKeys.length)];
        const el = document.createElement('div');
        el.className = 'tile';
        if(animate) el.style.top = `-${100/ROWS}%`; // å¾å¤©è€Œé™
        
        const inner = document.createElement('div');
        inner.className = 'tile-inner';
        const img = document.createElement('img');
        img.src = CHAR_DB[type].img;
        inner.appendChild(img);
        el.appendChild(inner);

        // ç¶å®šäº‹ä»¶
        el.addEventListener('touchstart', handleTouchStart, {passive: false});
        el.addEventListener('touchend', handleTouchEnd, {passive: false});
        el.addEventListener('mousedown', handleMouseDown); 

        gridEl.appendChild(el);
        const tile = { r, c, type, el, isSkill: false, isFrozen: false, isStone: false };
        grid[r][c] = tile;
        updateTilePos(tile, animate);
        return tile;
    }

    // --- 4. è¼¸å…¥èˆ‡è§¸æ§ (Input Handling) ---
    function handleTouchStart(e) {
        if(isProcessing || isPaused) return;
        const t = e.changedTouches[0];
        startX = t.clientX; startY = t.clientY;
        activeInputTile = getTileFromEl(e.target);
        if(activeInputTile) activeInputTile.el.classList.add('pressed');
        
        // é“å…·æ¨¡å¼é»æ“Šå³è§¸ç™¼
        if(activeProp && activeInputTile) triggerProp(activeInputTile);
    }

    function handleTouchEnd(e) {
        if(activeInputTile) activeInputTile.el.classList.remove('pressed');
        if(isProcessing || !activeInputTile || activeProp) return;
        const t = e.changedTouches[0];
        handleSwipe(t.clientX - startX, t.clientY - startY);
        activeInputTile = null;
    }

    function handleMouseDown(e) {
        if(isProcessing || isPaused) return;
        startX = e.clientX; startY = e.clientY;
        activeInputTile = getTileFromEl(e.target);
        if(activeInputTile) activeInputTile.el.classList.add('pressed');
        if(activeProp && activeInputTile) triggerProp(activeInputTile);

        document.onmouseup = (ev) => {
            if(activeInputTile) activeInputTile.el.classList.remove('pressed');
            if(!activeInputTile || activeProp) return;
            handleSwipe(ev.clientX - startX, ev.clientY - startY);
            document.onmouseup = null;
            activeInputTile = null;
        };
    }

    function handleSwipe(dx, dy) {
        if(Math.abs(dx) > 30 || Math.abs(dy) > 30) {
            let tr = activeInputTile.r, tc = activeInputTile.c;
            if(Math.abs(dx) > Math.abs(dy)) dx > 0 ? tc++ : tc--;
            else dy > 0 ? tr++ : tr--;
            if(isValid(tr, tc)) swapTiles(activeInputTile, grid[tr][tc]);
        }
    }

    // --- 5. æ ¸å¿ƒé‚è¼¯ (Core Logic) ---
    async function swapTiles(t1, t2) {
        // è™›ç©ºç„¡æ³•ç§»å‹•
        if(t1.isVoid || t2.isVoid) return;

        // å†°å¡Šç„¡æ³•ç§»å‹•
        if(t1.isFrozen || t2.isFrozen || t1.isStone || t2.isStone) {
            playSound('swapFail');
            t1.el.animate([{transform:'translateX(0)'}, {transform:'translateX(5px)'}, {transform:'translateX(0)'}], {duration: 150});
            return;
        }

        isProcessing = true;
        // äº¤æ›æ•¸æ“šèˆ‡è¦–è¦º
        let tmpType = t1.type; t1.type = t2.type; t2.type = tmpType;
        let tmpSkill = t1.isSkill; t1.isSkill = t2.isSkill; t2.isSkill = tmpSkill;
        updateTileContent(t1); updateTileContent(t2);
        comboCount = 0;
        
        await wait(200);
        const matches = findMatches();
        if(matches.length > 0) {
            await processMatches(matches);
        } else {
            // äº¤æ›å¤±æ•—
            playSound('swapFail');
            // é‚„åŸ
            tmpType = t1.type; t1.type = t2.type; t2.type = tmpType;
            tmpSkill = t1.isSkill; t1.isSkill = t2.isSkill; t2.isSkill = tmpSkill;
            updateTileContent(t1); updateTileContent(t2);
            // æŠ–å‹•å‹•ç•«
            t1.el.animate([{transform:'translateX(0)'}, {transform:'translateX(10px)'}, {transform:'translateX(0)'}], {duration: 200});
            isProcessing = false;
        }
    }

    async function processMatches(matches) {
        comboCount++;
        if(comboCount > 1) {
            showCombo(comboCount);
            playSound('match');
        }

        if (isBossLevel) {
            bossAttackCounter++;
            if (bossAttackCounter >= currentBossAttackThreshold) {
                await bossAttack();
            }
        }

        let scoreGain = 0;
        let removeSet = new Set();
        let skillSpawns = []; 

        // è™•ç†å†°å¡Šæ¶ˆé™¤ (æ¶ˆé™¤å‘¨åœçš„å†°å¡Š)
        matches.forEach(m => {
            m.forEach(t => {
                // æª¢æŸ¥ä¸Šä¸‹å·¦å³é„°å±…
                [[0,1],[0,-1],[1,0],[-1,0]].forEach(([dr, dc]) => {
                    let nr = t.r + dr, nc = t.c + dc;
                    if(isValid(nr, nc) && grid[nr][nc].isFrozen) {
                        grid[nr][nc].isFrozen = false;
                        grid[nr][nc].el.classList.remove('frozen');
                        createVFX('ice_break', grid[nr][nc]);
                    }
                });
            });
        });

        // Fever æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰æ¶ˆé™¤éƒ½æœƒå¼•ç™¼é¡å¤–çˆ†ç‚¸ï¼
        if (isFeverTime) {
            matches.forEach(m => {
                // éš¨æ©Ÿé¸ä¸€å€‹é»ä½œç‚ºçˆ†ç‚¸ä¸­å¿ƒ
                let center = m[0];
                for(let r=center.r-1; r<=center.r+1; r++) 
                    for(let c=center.c-1; c<=center.c+1; c++) 
                        if(isValid(r,c)) removeSet.add(grid[r][c]);
                createVFX('area', center); // è¦–è¦ºç‰¹æ•ˆ
                
                // Fever æ‰‹æ„Ÿå„ªåŒ–ï¼šå¢åŠ ç•«é¢æ™ƒå‹•
                const stage = document.getElementById('game-stage');
                stage.classList.remove('shake'); void stage.offsetWidth; stage.classList.add('shake');
            });
        }

        matches.forEach(m => {
            // 4å€‹ä»¥ä¸Šç”ŸæˆæŠ€èƒ½æ£‹
            if(m.length >= 4) {
                const center = m[Math.floor(m.length/2)];
                if (!removeSet.has(center)) skillSpawns.push(center); // é¿å…å·²è¢« Fever çˆ†ç‚¸é¸ä¸­çš„æ ¼å­
                m = m.filter(t => t !== center); // ä¸­å¿ƒé»ä¸æ¶ˆé™¤ï¼Œè½‰ç‚ºæŠ€èƒ½
            }
            m.forEach(t => removeSet.add(t));
            scoreGain += m.length * 10 * (1 + (comboCount * 0.2));
            if(m.length > 3) scoreGain += 20; // é¡å¤–åŠ åˆ†

            // éš¨æ©Ÿå°è©±
            if(Math.random() < 0.6) triggerDialogue(m[0].type, 'match');

            // è§¸ç™¼é€£ç·šä¸­çš„æŠ€èƒ½
            m.forEach(t => { 
                if(t.isSkill) { 
                    triggerSkillEffect(t, removeSet); 
                    triggerDialogue(t.type, 'skill'); 
                } 
            });
        });

        // å¢åŠ  Fever å€¼
        if (!isFeverTime) {
            feverValue = Math.min(MAX_FEVER, feverValue + (matches.length * 12)); // å¢åŠ  Fever ç²å–é€Ÿåº¦ (çˆ½æ„ŸUP)
            if (feverValue >= MAX_FEVER) activateFever();
        }

        // å° BOSS é€ æˆå‚·å®³æˆ–å¢åŠ åˆ†æ•¸
        if (isBossLevel) {
            damageBoss(scoreGain * 2); // BOSSæˆ°å‚·å®³åŠ å€
        } else {
            addScore(scoreGain);
        }
        playSound('match');
        if (window.navigator && window.navigator.vibrate) navigator.vibrate(isFeverTime ? 60 : 30);
        
        // è¦–è¦ºæ¶ˆé™¤
        removeSet.forEach(t => t.el.classList.add('matched'));
        
        await wait(350);

        // æ•¸æ“šæ¸…é™¤
        removeSet.forEach(t => {
            t.type = null; t.isSkill = false; t.isFrozen = false; t.isStone = false;
            t.el.classList.remove('matched', 'skill-ready');
            t.el.style.display = 'none'; // éš±è—
        });

        // å‡ç´šæŠ€èƒ½æ£‹
        skillSpawns.forEach(t => {
            t.isSkill = true; t.el.classList.add('skill-ready');
            showFloatText('Skill!', t.el);
        });

        // é‡åŠ›ä¸‹è½
        await applyGravity();

        // é€£é–æª¢æŸ¥
        const newM = findMatches();
        if(newM.length > 0) await processMatches(newM);
        else {
            if (!hasValidMoves()) {
                showFloatText("No Moves! Shuffling...", gridEl);
                await wait(1000);
                shuffleBoard();
                return;
            }
            isProcessing = false;
            checkLevelProgress();
        }
    }

    // --- 6. é“å…·ç‰©ç†ä¿®æ­£ (Fixed Logic) ---
    async function triggerProp(t) {
        if(props[activeProp] <= 0) return;
        props[activeProp]--; updatePropUI();
        isProcessing = true;
        
        const pType = activeProp;
        activeProp = null;
        document.querySelectorAll('.item-btn').forEach(b => b.classList.remove('active'));

        // éŸ³æ•ˆèˆ‡å°è©±
        if(pType === 'bomb') {
            triggerDialogue('noran', 'item');
            playSound('bomb');
        } else if(pType === 'lightning') {
            triggerDialogue('james', 'item');
            playSound('skill');
        }

        let set = new Set();
        createVFX(pType, t);

        // è¨ˆç®—ç¯„åœ
        if(pType === 'bomb') {
            for(let r=t.r-1; r<=t.r+1; r++) for(let c=t.c-1; c<=t.c+1; c++) 
                if(isValid(r,c)) set.add(grid[r][c]);
        } else if(pType === 'lightning') {
            for(let i=0; i<COLS; i++) set.add(grid[t.r][i]);
            for(let i=0; i<ROWS; i++) set.add(grid[i][t.c]);
        }

        // è¦–è¦ºæ¨™è¨˜
        set.forEach(tile => {
            if(tile.isVoid) return;
            tile.el.classList.add('matched');
        });

        await wait(400);
        
        // --- ä¿®æ­£é—œéµï¼šç‰©ç†æ¸…é™¤ ---
        // åœ¨é‡åŠ›è¨ˆç®—å‰ï¼Œå¿…é ˆæ˜ç¢ºå°‡é€™äº›æ ¼å­è¨­ç‚º null ä¸¦éš±è—
        set.forEach(tile => {
            if(tile.isVoid) return;
            tile.type = null; 
            tile.isSkill = false;
            tile.el.classList.remove('matched', 'skill-ready');
            tile.el.style.display = 'none'; // ç¢ºä¿çœ‹ä¸è¦‹
        });

        // å‘¼å«é‡åŠ›å¡«è£œç©ºç¼º
        await applyGravity();
        
        // æª¢æŸ¥é“å…·æ˜¯å¦å¼•ç™¼é€£é–
        const m = findMatches();
        if(m.length > 0) await processMatches(m);
        else isProcessing = false;
    }

    // --- 7. é‡åŠ›ç³»çµ± (Gravity System) ---
    async function applyGravity() {
        for(let c=0; c<COLS; c++) {
            let write = ROWS - 1;
            // 1. ç§»å‹•ç¾æœ‰æ–¹å¡Šå¡«è£œç©ºç¼º
            for(let r=ROWS-1; r>=0; r--) {
                if(grid[r][c].type !== null && !grid[r][c].isVoid) {
                    if(write !== r) { // åƒ…åœ¨éœ€è¦ç§»å‹•æ™‚æ‰æ“ä½œ
                        // æ•¸æ“šæ¬ç§»
                        grid[write][c].type = grid[r][c].type;
                        grid[write][c].isSkill = grid[r][c].isSkill;
                        // åŸä½ç½®æ¸…ç©º
                        grid[r][c].type = null;
                        grid[r][c].isSkill = false;
                        grid[r][c].isFrozen = false;
                        grid[r][c].isStone = false;
                        
                        // è¦–è¦ºæ›´æ–°
                        updateTileContent(grid[write][c]);
                        updateTileContent(grid[r][c]);
                    }
                    do { write--; } while(write >= 0 && grid[write][c].isVoid); // è·³éè™›ç©º
                }
                else if (grid[r][c].isVoid && write === r) write--; // å¦‚æœç•¶å‰å¯«å…¥é»æ˜¯è™›ç©ºï¼Œå‘ä¸Šç§»
            }
            // 2. ä¸Šæ–¹ç”Ÿæˆæ–°æ–¹å¡Š
            for(let r=write; r>=0; r--) {
                if(grid[r][c].isVoid) continue;
                grid[r][c].type = activeCharKeys[Math.floor(Math.random() * activeCharKeys.length)];
                grid[r][c].isSkill = false;
                grid[r][c].isFrozen = false;
                grid[r][c].isStone = false;
                const t = grid[r][c];
                updateTileContent(t); // é¡¯ç¤ºå‡ºä¾†
                // å‹•ç•«è™•ç†
                t.el.style.transition = 'none';
                t.el.style.top = `-${(write - r + 1) * (100/ROWS)}%`; // æ ¹æ“šè·é›¢æ±ºå®šèµ·å§‹ä½ç½®
                void t.el.offsetHeight; // å¼·åˆ¶é‡ç¹ª
                t.el.style.transition = 'top 0.4s cubic-bezier(0.19, 1, 0.22, 1)';
                updateTilePos(t, true); // æ»‘è½
            }
        }
        await wait(450); // ç­‰å¾…æ‰€æœ‰æ‰è½å®Œæˆ
    }

    // --- Fever ç³»çµ± ---
    function activateFever() {
        isFeverTime = true;
        document.body.classList.add('fever-mode');
        document.getElementById('ui-fever-text').innerText = "FEVER TIME!!!";
        playSound('levelUp'); // å€Ÿç”¨å‡ç´šéŸ³æ•ˆ
        showFloatText("FEVER TIME!", gridEl);

        // åˆ‡æ›éŸ³æ¨‚
        currentPlayingBGM.pause();
        FEVER_BGM.currentTime = 0;
        FEVER_BGM.play().catch(()=>{});
        
        // éœ‡å‹•è¢å¹•
        document.getElementById('game-stage').classList.add('shake');
        setTimeout(() => document.getElementById('game-stage').classList.remove('shake'), 500);

        setTimeout(() => {
            isFeverTime = false;
            feverValue = 0;
            document.body.classList.remove('fever-mode');
            document.getElementById('ui-fever-text').innerText = "FEVER";
            
            // åˆ‡æ›å› BGM
            FEVER_BGM.pause(); 
            currentPlayingBGM.play().catch(()=>{});
            
            updateUI();
        }, 15000); // æŒçºŒæ™‚é–“å»¶é•·è‡³ 15 ç§’
    }

    // --- BOSS æˆ°ç³»çµ± ---
    function damageBoss(amount) {
        bossCurrentHP = Math.max(0, bossCurrentHP - amount);
        updateBossUI();
        showFloatText(`-${amount}`, document.getElementById('boss-img'));
        
        // BOSS å—å‚·ç‰¹æ•ˆ
        const bossImg = document.getElementById('boss-img');
        bossImg.classList.remove('boss-damaged');
        void bossImg.offsetWidth;
        bossImg.classList.add('boss-damaged');
        
        // ç‹‚æš´æ¨¡å¼æª¢æ¸¬ (HP < 30%)
        if (!isBossBerserk && bossCurrentHP > 0 && (bossCurrentHP / bossMaxHP) < 0.3) {
            isBossBerserk = true;
            document.body.classList.add('boss-berserk');
            currentBossAttackThreshold = Math.max(2, Math.floor(currentBossAttackThreshold / 2)); // æ”»æ“Šé »ç‡åŠ å€
            triggerDialogue(currentBossKey, 'boss_attack', "ä¸å¯åŸè«’... å¾¹åº•æ¶ˆå¤±å§ï¼ï¼ï¼");
            showFloatText("BERSERK MODE!", document.getElementById('boss-img'));
            const stage = document.getElementById('game-stage');
            stage.classList.remove('shake'); void stage.offsetWidth; stage.classList.add('shake');
        }

        if (bossCurrentHP <= 0) {
            checkLevelProgress(); // BOSS è¢«æ“Šæ•—
        }
    }

    async function bossAttack() {
        bossAttackCounter = 0;
        
        // BOSS æ”»æ“Šç‰¹æ•ˆ
        const bossImg = document.getElementById('boss-img');
        bossImg.classList.remove('boss-damaged'); // ç§»é™¤å—å‚·ç‹€æ…‹ä»¥å…è¡çª
        bossImg.classList.add('boss-attacking');
        
        // ç•«é¢è®Šæš—èšç„¦
        const stage = document.getElementById('game-stage');
        const originalFilter = stage.style.filter;
        stage.style.filter = "brightness(0.7) contrast(1.2)";
        
        triggerDialogue(currentBossKey, 'boss_attack');
        
        await wait(800); // ç­‰å¾…è“„åŠ›å‹•ç•«

        const attackTypes = ['freeze', 'blind', 'shuffle', 'stone'];
        const selectedAttack = attackTypes[Math.floor(Math.random() * attackTypes.length)];

        switch (selectedAttack) {
            case 'freeze':
                // éš¨æ©Ÿå†°å‡ 2-3 å€‹æ ¼å­
                let frozenCount = 0;
                const toFreeze = 2 + Math.floor(Math.random() * 2); // 2 or 3
                for(let i=0; i<30; i++) { // å˜—è©¦30æ¬¡
                    let r = Math.floor(Math.random()*ROWS), c = Math.floor(Math.random()*COLS);
                    if(isValid(r,c) && !grid[r][c].isFrozen) {
                        grid[r][c].isFrozen = true; updateTileContent(grid[r][c]);
                        createVFX('ice_break', grid[r][c]);
                        if(++frozenCount >= toFreeze) break;
                    }
                }
                break;
            case 'blind':
                const blindEl = document.getElementById('blind-overlay');
                const x = 30 + Math.random() * 40; const y = 30 + Math.random() * 40;
                blindEl.style.background = `radial-gradient(circle at ${x}% ${y}%, transparent 30%, rgba(0,0,0,0.85) 60%)`;
                blindEl.classList.add('show');
                setTimeout(() => blindEl.classList.remove('show'), 4000);
                break;
            case 'shuffle':
                await shuffleBoard();
                break;
            case 'stone':
                // éš¨æ©Ÿå°‡ 2 å€‹æ ¼å­è®ŠæˆçŸ³é ­
                for(let i=0; i<2; i++) {
                    let r = Math.floor(Math.random()*ROWS), c = Math.floor(Math.random()*COLS);
                    if(isValid(r,c) && !grid[r][c].isStone && !grid[r][c].isFrozen && !grid[r][c].isSkill) {
                        grid[r][c].isStone = true; updateTileContent(grid[r][c]);
                        createVFX('stone_hit', grid[r][c]);
                    }
                }
                break;
        }
        
        // æ¢å¾©ç‹€æ…‹
        bossImg.classList.remove('boss-attacking');
        stage.style.filter = originalFilter || "";
        await wait(200); // æ”»æ“Šå¾Œçš„å°åœé “
    }

    // --- 8. æŠ€èƒ½èˆ‡é“å…·é‚è¼¯ ---
    function triggerSkillEffect(t, set) {
        const type = CHAR_DB[t.type].type;
        const level = (gameState.charLevels[t.type] || 1);
        // å‡ç´šæ•ˆæœï¼šæ¯ç´šå¢åŠ  1 å€‹é¡å¤–æ¶ˆé™¤ (æˆ– Fever å€¼)
        let extraPower = level - 1;

        // è¯æ”œæŠ€æª¢æ¸¬
        const charData = CHAR_DB[t.type];
        let partnerKey = null;
        if (charData.synergy) {
            partnerKey = charData.synergy.find(pk => activeCharKeys.includes(pk));
            if (partnerKey) {
                extraPower += 3; // è¯æ”œåŠ æˆï¼šå¤§å¹…å¢å¼·æ•ˆæœ
                showFloatText("Synergy Bonus!", t.el);
            }
        }

        createVFX(type, t);
        playSound('skill');
        
        // æŠ€èƒ½æ‰‹æ„Ÿå„ªåŒ–ï¼šé‡‹æ”¾æŠ€èƒ½æ™‚éœ‡å‹•èˆ‡æ™ƒå‹•
        if (window.navigator && window.navigator.vibrate) navigator.vibrate(50);
        const stage = document.getElementById('game-stage');
        stage.classList.remove('shake'); void stage.offsetWidth; stage.classList.add('shake');
        
        // è§¸ç™¼æŠ€èƒ½/è¯æ”œ Cut-in èˆ‡èªéŸ³
        if (partnerKey) {
             showSynergyCutin(t.type, partnerKey);
             triggerDialogue(t.type, 'synergy');
        } else {
             showSkillCutin(t.type);
             triggerDialogue(t.type, 'skill');
        }
        
        if(type === 'random') {
            const count = 5 + extraPower;
            for(let i=0; i<count; i++) set.add(grid[Math.floor(Math.random()*ROWS)][Math.floor(Math.random()*COLS)]); 
        } else if (type === 'area') {
            for(let r=t.r-1; r<=t.r+1; r++) for(let c=t.c-1; c<=t.c+1; c++) if(isValid(r,c)) set.add(grid[r][c]);
            // ç¯„åœæŠ€èƒ½å‡ç´šï¼šéš¨æ©Ÿé¡å¤–æ¶ˆé™¤
            for(let i=0; i<extraPower; i++) set.add(grid[Math.floor(Math.random()*ROWS)][Math.floor(Math.random()*COLS)]);
        } else if (type === 'cross') {
            for(let i=0; i<COLS; i++) set.add(grid[t.r][i]); for(let i=0; i<ROWS; i++) set.add(grid[i][t.c]);
            for(let i=0; i<extraPower; i++) set.add(grid[Math.floor(Math.random()*ROWS)][Math.floor(Math.random()*COLS)]);
        } else if (type === 'row') {
            for(let c=0; c<COLS; c++) set.add(grid[t.r][c]);
            for(let i=0; i<extraPower; i++) set.add(grid[Math.floor(Math.random()*ROWS)][Math.floor(Math.random()*COLS)]);
        } else if (type === 'col') {
            for(let r=0; r<ROWS; r++) set.add(grid[r][t.c]);
            for(let i=0; i<extraPower; i++) set.add(grid[Math.floor(Math.random()*ROWS)][Math.floor(Math.random()*COLS)]);
        } else if (type === 'color') {
            grid.flat().forEach(x => { if(x.type === t.type) set.add(x); });
            for(let i=0; i<extraPower; i++) set.add(grid[Math.floor(Math.random()*ROWS)][Math.floor(Math.random()*COLS)]);
        } else if (type === 'convert') {
              for(let r=t.r-1; r<=t.r+1; r++) for(let c=t.c-1; c<=t.c+1; c++) 
                  if(isValid(r,c) && grid[r][c].type !== null) { grid[r][c].type = t.type; updateTileContent(grid[r][c]); }
          } else if (type === 'boost') {
              // ç¬é–“å¢åŠ  Fever
              feverValue = Math.min(MAX_FEVER, feverValue + 30 + (extraPower * 5));
              showFloatText("Fever Up!", t.el);
              if (feverValue >= MAX_FEVER && !isFeverTime) activateFever();
              updateUI();
          }
    }

    function useItem(name) {
        if(isProcessing || isPaused || props[name] <= 0) return;
        if(name === 'shuffle') {
            props.shuffle--; updatePropUI();
            triggerDialogue('estrella', 'item'); 
            playSound('shuffle');
            shuffleBoard(); return;
        }
        if(activeProp === name) {
            activeProp = null; document.querySelectorAll('.item-btn').forEach(b => b.classList.remove('active'));
        } else {
            activeProp = name;
            document.querySelectorAll('.item-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+name).classList.add('active');
            triggerDialogue(null, null, name==='bomb'?"é»æ“Šæ ¼å­æŠ•æ“²ç‚¸å½ˆï¼":"é»æ“Šæ ¼å­ç™¼å‹•é›·é›»ï¼");
        }
    }

    function shuffleBoard() {
        isProcessing = true;
        // Fisher-Yates Shuffle
        let types = grid.flat().filter(t => !t.isVoid).map(t => ({type: t.type, isSkill: t.isSkill})).sort(()=>Math.random()-0.5);
        let i=0;
        // è¦–è¦ºæ—‹è½‰å‹•ç•«
        grid.flat().forEach(t => { 
            if(t.isVoid) return;
            t.type = types[i].type; t.isSkill = types[i].isSkill; i++; 
            t.el.style.transform = 'scale(0) rotate(180deg)'; 
        });
        
        setTimeout(() => { 
            grid.flat().forEach(t => { 
                if(t.isVoid) return;
                updateTileContent(t); 
                t.el.style.transform = 'scale(1) rotate(0deg)'; 
            }); 
            isProcessing = false; 
            const m = findMatches(); 
            if(m.length>0) processMatches(m); 
        }, 500);
    }

    // --- 9. UI èˆ‡ç³»çµ±åŠŸèƒ½ ---
    function checkLevelProgress() {
        let levelCleared = false;
        if (isBossLevel && bossCurrentHP <= 0) {
            levelCleared = true;
        } else if (!isBossLevel && currentLevelScore >= targetScore) {
            levelCleared = true;
        }

        if(levelCleared) {
            isProcessing = true;
            playSound('levelUp');
            if (isBossLevel) {
                triggerDialogue(currentBossKey, 'boss_defeat');
            }
            setTimeout(() => {
                gameState.level++; 
                saveData();
                initLevel(); // é€²å…¥ä¸‹ä¸€é—œ
                isProcessing = false;
            }, 1500);
        }
    }

    let diaTimeout;
    let bossDiaTimeout;
    function triggerDialogue(charKey, type, customText) {
        let text = customText, img = "https://file.garden/aWe99vhwaGcNwkok/%E7%A0%B4%E9%A0%AD/%E6%98%9F%E6%98%9F.png", name = "æ˜Ÿæ˜Ÿ";
        if(charKey && CHAR_DB[charKey]) {
            const data = CHAR_DB[charKey];
            img = data.img; name = data.name;
            
            if (!text) {
                let quotePool = null;
                if (type.startsWith('boss_')) {
                    const quoteKey = type.replace('boss_', '');
                    if (data.boss_quotes && data.boss_quotes[quoteKey]) {
                        quotePool = data.boss_quotes[quoteKey];
                    } else {
                        if (quoteKey === 'intro') quotePool = [`æˆ‘æ˜¯ ${data.name}ï¼`, 'æº–å‚™å¥½æ¥å—æŒ‘æˆ°äº†å—ï¼Ÿ'];
                        else if (quoteKey === 'attack') quotePool = data.quotes.skill || ['æ¥æ‹›ï¼', 'çœ‹æˆ‘çš„å²å®³ï¼'];
                        else if (quoteKey === 'defeat') quotePool = ['å—š...', 'å¥½å¼·...', 'ä¸‹æ¬¡ä¸æœƒè¼¸äº†...'];
                    }
                } else if (type === 'synergy' && data.synergy_quotes) {
                    quotePool = data.synergy_quotes;
                } else if (data.quotes[type]) {
                    quotePool = data.quotes[type];
                }

                if (Array.isArray(quotePool)) text = quotePool[Math.floor(Math.random() * quotePool.length)];
                else if (typeof quotePool === 'string') text = quotePool;
            }
        }
        if(!text) return;
        
        // BOSS å°è©±ç‰¹æ®Šè™•ç† (é¡¯ç¤ºåœ¨ä¸Šæ–¹)
        if (isBossLevel && charKey === currentBossKey && type.startsWith('boss_')) {
            const bossDia = document.getElementById('boss-dialogue');
            bossDia.innerText = text;
            bossDia.classList.add('show');
            clearTimeout(bossDiaTimeout);
            bossDiaTimeout = setTimeout(() => bossDia.classList.remove('show'), 3000);
            return;
        }

        const bubble = document.getElementById('dialogue-bubble');
        document.getElementById('d-img').src = img;
        document.getElementById('d-name').innerText = name;
        document.getElementById('d-text').innerText = text;
        
        bubble.classList.add('show');
        clearTimeout(diaTimeout);
        diaTimeout = setTimeout(() => bubble.classList.remove('show'), 3500); // 3.5ç§’å¾Œæ¶ˆå¤±
    }

    function showSkillCutin(charKey) {
        const layer = document.getElementById('skill-cutin-layer');
        const img = document.getElementById('cutin-img');
        const normalContainer = document.querySelector('.cutin-container');
        const synergyContainer = document.getElementById('synergy-container');

        if(CHAR_DB[charKey]) {
            img.src = CHAR_DB[charKey].img;
            
            synergyContainer.style.display = 'none';
            normalContainer.style.display = 'flex';

            layer.style.display = 'flex';
            layer.classList.remove('cutin-active');
            void layer.offsetWidth; // trigger reflow
            layer.classList.add('cutin-active');
            setTimeout(() => { layer.style.display = 'none'; }, 1500);
        }
    }

    function showSynergyCutin(charKey1, charKey2) {
        const layer = document.getElementById('skill-cutin-layer');
        const container = document.getElementById('synergy-container');
        const normalContainer = document.querySelector('.cutin-container');
        const img1 = document.getElementById('syn-img-1');
        const img2 = document.getElementById('syn-img-2');
        
        if(CHAR_DB[charKey1] && CHAR_DB[charKey2]) {
            img1.src = CHAR_DB[charKey1].img;
            img2.src = CHAR_DB[charKey2].img;
            
            normalContainer.style.display = 'none';
            container.style.display = 'flex';
            
            layer.style.display = 'flex';
            layer.classList.remove('cutin-active');
            void layer.offsetWidth; 
            layer.classList.add('cutin-active');
            
            setTimeout(() => { 
                layer.style.display = 'none'; 
                container.style.display = 'none';
                normalContainer.style.display = 'flex'; // Reset
            }, 2000);
        }
    }

    function toggleSkillInfo() {
        let msg = "ã€æœ¬å±€è§’è‰²æŠ€èƒ½ã€‘\n";
        activeCharKeys.forEach(key => { msg += `â— ${CHAR_DB[key].name}: ${SKILL_DESC[CHAR_DB[key].type]}\n`; });
        alert(msg);
    }

    function addScore(val) {
        const multiplier = isFeverTime ? 2 : 1;
        const finalScore = Math.round(val * multiplier);
        currentLevelScore += finalScore; 
        gameState.totalScore += finalScore;
        
        // åˆ†æ•¸è·³å‹•æ•ˆæœ
        const scoreEl = document.getElementById('ui-total-score');
        if (scoreEl) {
            scoreEl.style.transform = 'scale(1.2)';
            setTimeout(() => {
                scoreEl.style.transform = 'scale(1)';
            }, 150);
        }
        updateUI();

        // é€²åº¦æ¢é«˜å…‰æ•ˆæœ
        if (!isBossLevel) {
            const progressFill = document.getElementById('ui-progress');
            progressFill.classList.add('highlight');
            setTimeout(() => {
                progressFill.classList.remove('highlight');
            }, 400);
        }
    }
    
    function updateUI() {
        document.getElementById('ui-level').innerText = gameState.level;
        document.getElementById('ui-total-score').innerText = gameState.totalScore;
        document.getElementById('ui-current-score').innerText = Math.floor(currentLevelScore);
        document.getElementById('ui-target').innerText = targetScore;
        const pct = Math.min(100, (currentLevelScore / targetScore) * 100);
        document.getElementById('ui-progress').style.width = `${pct}%`;
        
        // æ›´æ–° Fever æ¢
        const feverPct = (feverValue / MAX_FEVER) * 100;
        document.getElementById('ui-fever-fill').style.width = isFeverTime ? '100%' : `${feverPct}%`;
    }

    function updateBossUI() {
        if (!isBossLevel) return;
        const pct = (bossCurrentHP / bossMaxHP) * 100;
        document.getElementById('boss-hp-fill').style.width = `${pct}%`;
        document.getElementById('boss-hp-text').innerText = `BOSS HP: ${bossCurrentHP} / ${bossMaxHP}`;
    }
    
    function updatePropUI() {
        document.getElementById('cnt-bomb').innerText = props.bomb;
        document.getElementById('cnt-lightning').innerText = props.lightning;
        document.getElementById('cnt-shuffle').innerText = props.shuffle;
    }

    function updateTileContent(t) {
        if(t.isVoid) return;
        if(t.type === null) { 
            t.el.style.display = 'none'; 
            t.el.classList.remove('skill-ready'); 
            return; 
        }
        t.el.style.display = 'block'; 
        t.el.querySelector('img').src = CHAR_DB[t.type].img;
        if(t.isSkill) t.el.classList.add('skill-ready'); 
        else t.el.classList.remove('skill-ready');
        if(t.isFrozen) t.el.classList.add('frozen');
        else t.el.classList.remove('frozen');
        if(t.isStone) t.el.classList.add('stone');
        else t.el.classList.remove('stone');
    }
    
    function updateTilePos(t, animate) { 
        t.el.style.left = `${t.c * (100/COLS)}%`; 
        t.el.style.top = `${t.r * (100/ROWS)}%`; 
    }

    // --- 10. è¼”åŠ©å‡½å¼ (Utils) ---
    function findMatches() {
        let res = [];
        // æ©«å‘æª¢æŸ¥
        for(let r=0; r<ROWS; r++) {
            let m = [grid[r][0]];
            for(let c=1; c<COLS; c++) {
                if(!grid[r][c].isVoid && !grid[r][c].isStone && grid[r][c].type && grid[r][c].type === grid[r][c-1].type && !grid[r][c-1].isStone) m.push(grid[r][c]);
                else { if(m.length>=3) res.push([...m]); m=[grid[r][c]]; }
            }
            if(m.length>=3) res.push([...m]);
        }
        // ç¸±å‘æª¢æŸ¥
        for(let c=0; c<COLS; c++) {
            let m = [grid[0][c]];
            for(let r=1; r<ROWS; r++) {
                if(!grid[r][c].isVoid && !grid[r][c].isStone && grid[r][c].type && grid[r][c].type === grid[r-1][c].type && !grid[r-1][c].isStone) m.push(grid[r][c]);
                else { if(m.length>=3) res.push([...m]); m=[grid[r][c]]; }
            }
            if(m.length>=3) res.push([...m]);
        }
        return res;
    }

    function hasValidMoves() {
        for(let r=0; r<ROWS; r++) {
            for(let c=0; c<COLS; c++) {
                if(grid[r][c].isVoid || grid[r][c].isFrozen || grid[r][c].isStone || grid[r][c].type === null) continue;
                // Check Right
                if(c < COLS-1 && !grid[r][c+1].isVoid && !grid[r][c+1].isFrozen && !grid[r][c+1].isStone && grid[r][c+1].type !== null) {
                    let t1 = grid[r][c], t2 = grid[r][c+1];
                    let type1 = t1.type, type2 = t2.type;
                    t1.type = type2; t2.type = type1;
                    let m = findMatches();
                    t1.type = type1; t2.type = type2;
                    if(m.length > 0) return true;
                }
                // Check Down
                if(r < ROWS-1 && !grid[r+1][c].isVoid && !grid[r+1][c].isFrozen && !grid[r+1][c].isStone && grid[r+1][c].type !== null) {
                    let t1 = grid[r][c], t2 = grid[r+1][c];
                    let type1 = t1.type, type2 = t2.type;
                    t1.type = type2; t2.type = type1;
                    let m = findMatches();
                    t1.type = type1; t2.type = type2;
                    if(m.length > 0) return true;
                }
            }
        }
        return false;
    }

    function showCombo(count) {
        const el = document.getElementById('combo-display');
        el.innerText = count + " COMBO!";
        el.classList.remove('show');
        void el.offsetWidth;
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 1000);
    }

    function isValid(r, c) { return r>=0 && r<ROWS && c>=0 && c<COLS && !grid[r][c].isVoid; }
    function getTileFromEl(el) { const div = el.closest('.tile'); if(!div) return null; for(let r=0; r<ROWS; r++) for(let c=0; c<COLS; c++) if(grid[r][c].el === div) return grid[r][c]; return null; }
    function wait(ms) { return new Promise(r => setTimeout(r, ms)); }
    
    function showFloatText(txt, el) { 
        const d = document.createElement('div'); d.className = 'float-text'; 
        d.innerText = txt; 
        const rect = el.getBoundingClientRect(); 
        // ç¨å¾®ä¿®æ­£ä½ç½®åˆ°æ£‹ç›¤å…§
        d.style.left = (el.offsetLeft + 10) + 'px'; 
        d.style.top = el.offsetTop + 'px'; 
        vfxEl.appendChild(d); setTimeout(() => d.remove(), 1200); 
    }
    
    function createVFX(type, t) {
        const flash = document.createElement('div'); 
        flash.style.position='absolute'; 
        flash.style.left=(t.el.offsetLeft-50)+'px'; 
        flash.style.top=(t.el.offsetTop-50)+'px'; 
        flash.style.width='150px'; flash.style.height='150px'; 
        flash.style.borderRadius='50%'; 
        flash.style.background='radial-gradient(circle, transparent, white)'; 
        flash.style.zIndex='100';
        
        // æ ¹æ“šé¡å‹æ”¹è®Šç‰¹æ•ˆé¡è‰²
        if(type === 'ice_break') flash.style.background='radial-gradient(circle, transparent, #81D4FA)';
        if(type === 'stone_hit') flash.style.background='radial-gradient(circle, transparent, #757575)';
        if(type === 'area') flash.style.background='radial-gradient(circle, transparent, #FF5722)'; // çˆ†ç‚¸ç´…
        if(type === 'cross') flash.style.background='radial-gradient(circle, transparent, #FFD700)'; // åå­—é‡‘
        if(type === 'color') flash.style.background='radial-gradient(circle, transparent, #E040FB)'; // é­”æ³•ç´«

        // é¡å¤–å¢åŠ æ˜Ÿæ˜Ÿå™´ç™¼ç‰¹æ•ˆ (çˆ½æ„ŸUP)
        for(let i=0; i<5; i++) {
            const star = document.createElement('div');
            star.innerText = 'âœ¨';
            star.style.position = 'absolute';
            star.style.left = (t.el.offsetLeft + 20) + 'px';
            star.style.top = (t.el.offsetTop + 20) + 'px';
            star.style.fontSize = (10 + Math.random()*20) + 'px';
            star.style.zIndex = 101;
            vfxEl.appendChild(star);
            star.animate([
                { transform: 'translate(0,0) scale(0)', opacity: 1 },
                { transform: `translate(${(Math.random()-0.5)*100}px, ${(Math.random()-0.5)*100}px) scale(1.5)`, opacity: 0 }
            ], { duration: 600, easing: 'ease-out' });
            setTimeout(() => star.remove(), 600);
        }

        vfxEl.appendChild(flash); 
        flash.animate([{transform:'scale(0)', opacity:1}, {transform:'scale(2)', opacity:0}], {duration:400}); 
        setTimeout(()=>flash.remove(), 400);
    }

    // --- åœ–é‘‘ç³»çµ± ---
    function openGallery() {
        const screen = document.getElementById('gallery-screen');
        const gridContainer = document.createElement('div');
        gridContainer.className = 'gallery-grid';
        
        updateTeamUI();

        Object.keys(CHAR_DB).forEach(key => {
            const char = CHAR_DB[key];
            const isUnlocked = gameState.unlockedChars && gameState.unlockedChars.includes(key);
            const isSelected = gameState.selectedTeam.includes(key);

            const card = document.createElement('div');
            card.className = `char-card ${isUnlocked ? 'unlocked' : ''} ${isSelected ? 'selected' : ''}`;
            card.innerHTML = `
                <img src="${char.img}">
                <div class="char-name">${isUnlocked ? char.name : '???'}</div>
            `;
            if(isUnlocked) {
                card.onclick = () => {
                    if (!gameState.isRandomTeam) {
                        toggleCharSelection(key);
                        openGallery(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é¸å–ç‹€æ…‹
                    } else {
                        showCharDetail(key);
                    }
                };
            }
            gridContainer.appendChild(card);
        });
        
        document.getElementById('gallery-content').innerHTML = '';
        document.getElementById('gallery-content').appendChild(gridContainer);
        screen.style.display = 'flex';
    }
    
    function closeGallery() { document.getElementById('gallery-screen').style.display = 'none'; }

    function toggleTeamMode() {
        gameState.isRandomTeam = !gameState.isRandomTeam;
        saveData();
        openGallery(); // åˆ·æ–°ä»‹é¢
    }

    function toggleCharSelection(key) {
        const idx = gameState.selectedTeam.indexOf(key);
        if (idx >= 0) {
            gameState.selectedTeam.splice(idx, 1);
        } else {
            if (gameState.selectedTeam.length < 7) {
                gameState.selectedTeam.push(key);
            } else {
                alert("éšŠä¼å·²æ»¿ (æœ€å¤š7äºº)");
            }
        }
        saveData();
    }

    function updateTeamUI() {
        const statusEl = document.getElementById('team-status');
        const btn = document.getElementById('btn-team-toggle');
        if (gameState.isRandomTeam) {
            statusEl.innerText = "æ¨¡å¼: éš¨æ©Ÿ (æ¯å±€éš¨æ©Ÿ7äºº)";
            btn.innerText = "åˆ‡æ›è‡ªé¸";
            btn.classList.remove('active');
        } else {
            statusEl.innerText = `æ¨¡å¼: è‡ªé¸ (å·²é¸ ${gameState.selectedTeam.length}/7)`;
            btn.innerText = "åˆ‡æ›éš¨æ©Ÿ";
            btn.classList.add('active');
        }
    }
    
    function showCharDetail(key) {
        const char = CHAR_DB[key];
        const level = gameState.charLevels[key] || 1;
        const cost = level * 2000; // å‡ç´šèŠ±è²»å…¬å¼

        document.getElementById('detail-img').src = char.img;
        document.getElementById('detail-name').innerText = char.name;
        document.getElementById('detail-level').innerText = `Lv.${level}`;
        document.getElementById('detail-desc').innerHTML = `
            <b>æŠ€èƒ½é¡å‹:</b> ${SKILL_DESC[char.type]}<br><br>
            <b>ç•¶å‰æ•ˆæœ:</b> åŸºç¤æ•ˆæœ + ${level-1} å¼·åº¦<br><br>
            <b>èªéŸ³å°è©:</b><br>
            "${char.quotes.match[0]}"<br>
            "${char.quotes.skill[0]}"
        `;
        
        const btn = document.getElementById('btn-upgrade');
        btn.onclick = () => upgradeChar(key);
        if (gameState.totalScore >= cost) {
            btn.disabled = false;
            btn.innerText = `å‡ç´š (èŠ±è²»: ${cost} åˆ†)`;
        } else {
            btn.disabled = true;
            btn.innerText = `ç©åˆ†ä¸è¶³ (éœ€ ${cost})`;
        }

        document.getElementById('char-detail-overlay').style.display = 'flex';
    }

    function upgradeChar(key) {
        const level = gameState.charLevels[key] || 1;
        const cost = level * 2000;
        if (gameState.totalScore >= cost) {
            gameState.totalScore -= cost;
            gameState.charLevels[key] = level + 1;
            saveData();
            updateUI();
            playSound('levelUp');
            showCharDetail(key); // åˆ·æ–°ä»‹é¢
        }
    }

</script>
</body>
</html>
