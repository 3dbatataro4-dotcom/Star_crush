<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Code in Wonderland: Prologue V7</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Serif+TC:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. 全局設定 --- */
        :root {
            --primary: #d4af37; /* 古典金 */
            --bg-dark: #0a0510;
            /* 預設角色色，會被JS動態替換 */
            --char-color: #d4af37; 
            /* 新增變數 */
            --accent: #00ff41;  /* 駭客綠 */
            --danger: #ff4757;  /* 錯誤紅 */
            --glass: rgba(20, 30, 40, 0.9);
        }

        * { box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            background: #000;
            font-family: 'Noto Serif TC', serif;
            height: 100vh;
            height: 100dvh; /* Mobile viewport fix */
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        #game-stage {
            width: 100%; height: 100%; max-width: 480px;
            position: relative; overflow: hidden;
            background: #000;
            border: 1px solid #111;
            box-shadow: 0 0 60px rgba(0,0,0,0.8);
        }

        /* --- 2. 背景層 --- */
        .bg-layer {
            position: absolute; top: -5%; left: -5%; width: 110%; height: 110%;
            background-size: cover; background-position: center;
            transition: opacity 1.5s ease-in-out;
            z-index: 0;
            opacity: 0;
            filter: blur(2px) brightness(0.6); 
        }
        
        #bg-error { background-image: url('https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E5%A0%B4%E6%99%AF%E7%BE%8E%E8%A1%93%E7%B4%A0%E6%9D%90/%E5%BA%8F%E7%AB%A0/%E7%B3%BB%E7%B5%B1%E9%8C%AF%E8%AA%A4.jpg'); filter: blur(0px) brightness(0.9); }
        #bg-room { background-image: url('https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E5%A0%B4%E6%99%AF%E7%BE%8E%E8%A1%93%E7%B4%A0%E6%9D%90/%E5%BA%8F%E7%AB%A0/%E6%A0%B8%E5%BF%83%E6%8E%A7%E5%88%B6%E5%AE%A4.jpg'); }
        #bg-hole { background-image: url('https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E5%A0%B4%E6%99%AF%E7%BE%8E%E8%A1%93%E7%B4%A0%E6%9D%90/%E5%BA%8F%E7%AB%A0/%E6%95%B8%E6%93%9A%E5%85%94%E6%B4%9E.jpg'); filter: blur(2px) brightness(0.7); }
        
        /* 第一章背景 */
        #bg-door-closed { 
            background-image: url('https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E5%A0%B4%E6%99%AF%E7%BE%8E%E8%A1%93%E7%B4%A0%E6%9D%90/%E7%AC%AC%E4%B8%80%E7%AB%A0/unnamed%20(15).jpg'); 
            opacity: 0;
        }
        #bg-hallway { 
            background-image: url('https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E5%A0%B4%E6%99%AF%E7%BE%8E%E8%A1%93%E7%B4%A0%E6%9D%90/%E7%AC%AC%E4%B8%80%E7%AB%A0/BG_Hallway.jpg'); 
            opacity: 0;
        }
        /* 新增：第三關開啟的大門背景 */
        #bg-final-gate {
            background-image: url('https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E5%A0%B4%E6%99%AF%E7%BE%8E%E8%A1%93%E7%B4%A0%E6%9D%90/%E7%AC%AC%E4%B8%80%E7%AB%A0/Gemini_Generated_Image_vunt8zvunt8zvunt.png');
            opacity: 0;
        }

        /* --- 3. 角色層 (站位大修正) --- */
        .char-layer {
            position: absolute; bottom: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
            display: flex; justify-content: center; align-items: flex-end;
        }

        .char-img {
            position: absolute; bottom: 4%; /* 人物往上移動，避免被對話框遮擋太多 */
            max-height: 95%; max-width: 100%; /*人物稍微放大*/
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            opacity: 0; 
            transform-origin: bottom center;
        }

        /* --- 站位系統 (V7: 大幅拉開距離) --- */
        
        /* 獨白模式：正中間 (預設隱藏狀態：稍微縮小) */
        .pos-center { 
            left: 50%; 
            transform: translateX(-50%) scale(0.95); 
            z-index: 15; 
        }
        
        /* 雙人模式：左側 (預設隱藏狀態：往左退) */
        .pos-left { 
            left: -15%; 
            transform: translateX(-15%) scale(1.0); 
            z-index: 10; 
        }
        
        /* 雙人模式：右側 (預設隱藏狀態：往右退) */
        .pos-right { 
            right: -15%; 
            transform: translateX(15%) scale(1.0); 
            z-index: 10; 
        }

        /* 狀態類 */
        .active { 
            opacity: 1; 
            filter: brightness(1.1) drop-shadow(0 0 15px rgba(0,0,0,0.5)); 
            z-index: 20; 
        }
        
        .dim { 
            opacity: 1; 
            filter: brightness(0.4); /* 變暗 */
            z-index: 5; 
            /* transform: scale(0.85); 移除通用縮放，改用特定規則避免位置跑掉 */
        }
        
        /* 狀態覆寫：Active (正常顯示 - 滑入歸位) */
        .pos-center.active { transform: translateX(-50%) scale(1.05); }
        .pos-left.active   { transform: translateX(0) scale(1.0); }
        .pos-right.active  { transform: translateX(0) scale(1.0); }

        /* 狀態覆寫：Dim (變暗退後 - 保持歸位但縮小) */
        .pos-center.dim { transform: translateX(-50%) scale(1.0); }
        .pos-left.dim   { transform: translateX(0) scale(0.9); }
        .pos-right.dim  { transform: translateX(0) scale(0.9); }
        
        /* 特效動畫 */
        .anim-teleport { animation: teleportIn 1.5s forwards; }
        .anim-fall { animation: spinFall 3s forwards; }

        /* --- 4. UI 介面 (V7: 極致優化版) --- */
        .dialogue-wrapper {
            position: absolute; bottom: 12%; left: 5%; width: 90%; /* 對話框往上移動 */
            padding-bottom: env(safe-area-inset-bottom); /* 適配 iPhone 底部橫條 */
            z-index: 100; display: none;
        }

        /* 名字標籤 (V7: 古典銘牌風格) */
        .name-tag {
            position: absolute; top: -14px; left: 10px;
            /* 使用 CSS 變數製作金屬拉絲漸層 */
            background: linear-gradient(
                135deg, 
                #222 0%, 
                var(--char-color) 50%, 
                #222 100%
            );
            /* 金色雙重邊框與立體陰影 */
            border: 2px solid var(--primary);
            box-shadow: 
                inset 0 0 5px rgba(0,0,0,0.8), /* 內陰影 */
                0 3px 5px rgba(0,0,0,0.5),     /* 外陰影 */
                0 0 0 1px #000;                 /* 黑色描邊增加層次 */
            
            color: #fff; padding: 4px 25px; /* 縮小內距 */
            font-size: 16px; font-weight: bold; letter-spacing: 1px; /* 字體縮小 */
            z-index: 102;
            text-shadow: 1px 1px 2px #000, -1px -1px 2px #000; /* 強烈文字描邊 */
            
            /* 兩端切角造型 */
            clip-path: polygon(10% 0, 90% 0, 100% 50%, 90% 100%, 10% 100%, 0 50%);
            transform: scale(1.05); /* 稍微放大突出 */
        }

        /* 對話框本體 (V7: 細長菱形格紋) */
        .dialogue-box {
            background-color: rgba(15, 8, 25, 0.96);
            /* 使用角度創造細長菱形 */
            background-image: 
                linear-gradient(115deg, #000 25%, transparent 25%), 
                linear-gradient(245deg, #000 25%, transparent 25%), 
                linear-gradient(65deg,  #000 25%, transparent 25%), 
                linear-gradient(295deg, #000 25%, transparent 25%);
            background-position: 0 0;
            background-size: 30px 60px; /* 高度是寬度的兩倍 -> 細長菱形 */
            background-repeat: repeat;
            
            border: 2px solid var(--primary); /* 金框 */
            box-shadow: 
                inset 0 0 30px rgba(0,0,0,1), /* 內部深邃感 */
                0 5px 15px rgba(0,0,0,0.5); /* 外部立體感 */
                
            border-radius: 4px;
            padding: 30px 20px 20px 20px; /* 縮小對話框內距 */
            min-height: 110px; /* 降低最小高度 */
            color: #e0e0e0;
            position: relative;
        }

        /* 裝飾性內金線 */
        .dialogue-box::before {
            content: ''; position: absolute;
            top: 5px; bottom: 5px; left: 5px; right: 5px;
            border: 1px solid rgba(212, 175, 55, 0.4);
            pointer-events: none;
        }

        .dialogue-text { 
            font-size: 16px; line-height: 1.6; /* 字體縮小 */
            text-shadow: 1px 1px 1px #000;
            font-weight: 500;
        }
        
        /* 跳過按鈕 */
        .skip-btn {
            position: absolute; top: -28px; right: 0;
            color: #666; font-size: 12px; font-weight: bold;
            cursor: pointer; padding: 4px 12px;
            border: 1px solid #444; background: rgba(0,0,0,0.8);
            border-radius: 4px; letter-spacing: 1px;
            transition: all 0.3s; z-index: 105;
        }
        .skip-btn:hover { color: #fff; border-color: #fff; }
        .skip-btn.active { 
            color: var(--primary); border-color: var(--primary); 
            background: rgba(212, 175, 55, 0.15);
            animation: blink 1s infinite;
        }

        /* 繼續按鈕 (V7: 整合小花圖案) */
        .next-arrow { 
            position: absolute; bottom: 15px; right: 25px; 
            color: var(--primary); font-size: 14px; 
            animation: blink 1.5s infinite; cursor: pointer;
            letter-spacing: 1px;
            display: flex; align-items: center; /* 讓花和文字對齊 */
        }
        .next-arrow span { font-size: 18px; margin-right: 5px; } /* 小花樣式 */

        /* --- 5. 其他 --- */
        #flash-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: white; opacity: 0; pointer-events: none; z-index: 200;
        }
        
        /* --- 主介面優化 (V8) --- */
        #start-screen {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: radial-gradient(circle at center, #1a0b2e 0%, #050208 100%); z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow: hidden;
        }
        /* 裝飾背景 */
        #start-screen::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(212, 175, 55, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(212, 175, 55, 0.03) 1px, transparent 1px);
            background-size: 40px 40px; pointer-events: none;
        }
        
        .start-menu-card {
            background: rgba(20, 15, 30, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 175, 55, 0.3);
            padding: 60px 80px;
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5), inset 0 0 30px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; align-items: center;
            position: relative;
        }
        
        .btn-start {
            margin-top: 20px; width: 220px;
            padding: 15px 0; font-size: 16px; color: var(--primary); font-weight: bold;
            background: rgba(0,0,0,0.3); border: 1px solid var(--primary);
            cursor: pointer; box-shadow: 0 0 10px rgba(212, 175, 55, 0.1);
            font-family: 'Cinzel'; letter-spacing: 2px;
            transition: all 0.3s; text-align: center;
        }
        .btn-start:hover { 
            background: var(--primary); color: #000; 
            box-shadow: 0 0 25px var(--primary); transform: translateY(-2px);
        }

        /* --- 動畫 Keyframes --- */
        @keyframes teleportIn { 
            0% { opacity: 0; transform: translateX(-50%) scale(0.1); filter: brightness(5); } 
            60% { opacity: 1; transform: translateX(-50%) scale(1.1); filter: brightness(2); } 
            100% { opacity: 1; transform: translateX(-50%) scale(1); filter: brightness(1); } 
        }
        @keyframes spinFall { 
            0% { transform: translateX(-50%) scale(1) rotate(0deg); opacity: 1; }
            100% { transform: translateX(-50%) scale(0.1) rotate(720deg); opacity: 0; } 
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        @keyframes flashAnim { 0% { opacity: 1; } 100% { opacity: 0; } }

        /* 點擊特效 */
        .click-effect {
            position: absolute;
            border-radius: 50%;
            border: 2px solid var(--primary);
            background: rgba(212, 175, 55, 0.2);
            transform: translate(-50%, -50%);
            pointer-events: none;
            animation: clickRipple 0.4s ease-out forwards;
            z-index: 9999;
        }
        @keyframes clickRipple {
            0% { width: 10px; height: 10px; opacity: 1; }
            100% { width: 80px; height: 80px; opacity: 0; }
        }

        /* --- 新增：解謎介面樣式 --- */
        
        /* 視覺回饋區 */
        .visual-container {
            position: absolute; top: 10%; left: 50%; transform: translateX(-50%);
            width: 90%; display: flex; justify-content: center; z-index: 5;
            pointer-events: none;
        }
        .error-popup, .success-popup {
            padding: 10px 20px; border-radius: 4px;
            font-family: 'Fira Code', monospace; font-size: 14px; text-align: center;
            backdrop-filter: blur(4px); display: none;
        }
        .error-popup {
            background: rgba(20, 0, 0, 0.6); border: 1px solid var(--danger); color: var(--danger);
            animation: glitch 2s infinite;
        }
        .success-popup {
            background: rgba(0, 20, 0, 0.6); border: 1px solid var(--accent); color: var(--accent);
        }

        /* 編輯器按鈕 */
        .vision-btn {
            position: absolute; top: 80px; right: 20px; /* 下移以避開選單按鈕 */
            width: 45px; height: 45px; /* 調整大小與系統按鈕一致 */
            background: rgba(0,0,0,0.7); border: 2px solid var(--accent);
            border-radius: 50%; color: var(--accent);
            display: flex; align-items: center; justify-content: center;
            font-family: 'Fira Code', monospace; font-size: 20px; /* 字體大小調整 */
            cursor: pointer; z-index: 90; 
            box-shadow: 0 0 15px var(--accent);
            animation: pulse 2s infinite;
        }

        /* 代碼編輯器 */
        #code-editor {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 65%;
            /* 全息風格背景 */
            background: rgba(5, 15, 30, 0.9); 
            border-top: 2px solid var(--accent);
            border-left: 1px solid rgba(0, 255, 65, 0.3);
            border-right: 1px solid rgba(0, 255, 65, 0.3);
            box-shadow: 
                0 0 30px rgba(0, 255, 65, 0.15), 
                inset 0 0 50px rgba(0, 20, 40, 0.8);
            backdrop-filter: blur(5px);
            /* 網格線效果 */
            background-image: 
                linear-gradient(rgba(0, 255, 65, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 65, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
            
            z-index: 200;
            transform: translateY(110%);
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            padding: 20px;
            display: flex; flex-direction: column;
        }
        #code-editor.open { transform: translateY(0); }

        .editor-header {
            color: var(--accent); font-family: 'Fira Code', monospace; font-size: 14px;
            display: flex; justify-content: space-between; margin-bottom: 15px;
            padding-bottom: 10px; border-bottom: 1px solid rgba(0, 255, 65, 0.3);
            text-shadow: 0 0 5px var(--accent);
        }

        .code-list { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }

        /* 指令塊 */
        .code-block {
            background: rgba(0, 20, 40, 0.6);
            border: 1px solid rgba(0, 255, 65, 0.2);
            border-left: 4px solid #555;
            color: #aaffc3; padding: 15px; border-radius: 4px;
            font-family: 'Fira Code', monospace; font-size: 14px;
            display: flex; align-items: center; position: relative;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            cursor: grab; user-select: none;
            transition: transform 0.2s;
        }
        .code-block::before { content: '⋮⋮'; color: #666; margin-right: 15px; font-size: 20px; }
        .code-block.dragging { opacity: 0.3; transform: scale(0.95); }
        .code-block.running { border-left-color: #fff; background: #444; color: #fff; }
        .code-block.success { border-left-color: var(--accent); color: var(--accent); background: rgba(0,255,65,0.1); }
        .code-block.error { border-left-color: var(--danger); color: var(--danger); background: rgba(255,71,87,0.1); }

        .run-btn {
            background: rgba(0, 255, 65, 0.1); 
            border: 1px solid var(--accent);
            color: var(--accent); 
            padding: 15px; font-family: 'Fira Code', monospace; font-weight: bold; font-size: 16px;
            margin-top: 15px; border-radius: 4px; cursor: pointer;
            text-align: center; box-shadow: 0 0 15px rgba(0, 255, 65, 0.1);
            text-transform: uppercase; letter-spacing: 2px; /* 移除預設光暈，讓文字清晰可見 */
            transition: all 0.3s;
        }
        .run-btn:hover { background: var(--accent); color: #000; box-shadow: 0 0 30px var(--accent); text-shadow: none; }
        .run-btn:disabled { background: #555; color: #888; box-shadow: none; cursor: not-allowed; }

        /* --- 8. 系統選單 (章節 + 背包) --- */
        .system-menu-btn {
            position: absolute; top: 20px; right: 20px;
            width: 45px; height: 45px;
            background: rgba(0,0,0,0.8); border: 1px solid var(--primary);
            color: var(--primary); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 2000;
            font-size: 20px; box-shadow: 0 0 10px var(--primary);
            transition: all 0.3s;
        }
        .system-menu-btn:hover { background: var(--primary); color: #000; }

        #system-menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 10, 0.95); z-index: 2100;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(10px);
        }
        .sys-menu-container {
            width: 90%; max-width: 500px; height: 80%;
            background: rgba(20, 20, 25, 0.9);
            border: 1px solid #333; border-radius: 8px;
            display: flex; flex-direction: column;
            position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        .sys-tabs { display: flex; border-bottom: 1px solid #333; }
        .sys-tab {
            flex: 1; padding: 15px; background: transparent; border: none;
            color: #666; font-family: 'Noto Serif TC', serif; font-size: 16px;
            cursor: pointer; transition: 0.3s;
        }
        .sys-tab.active { color: var(--primary); background: rgba(212, 175, 55, 0.1); border-bottom: 2px solid var(--primary); }
        .sys-content { flex: 1; padding: 20px; overflow-y: auto; display: none; }
        .sys-content.active { display: block; }
        .btn-close-menu { position: absolute; top: -15px; right: -15px; width: 30px; height: 30px; background: var(--danger); color: #fff; border: none; border-radius: 50%; cursor: pointer; font-weight: bold; z-index: 10; }

        .chapter-list { display: flex; flex-direction: column; gap: 15px; }
        .chapter-btn {
            padding: 20px; background: rgba(255,255,255,0.05); border: 1px solid #333;
            color: #555; font-family: 'Noto Serif TC', serif; font-size: 16px;
            cursor: not-allowed; transition: all 0.3s; position: relative;
            display: flex; justify-content: space-between; align-items: center;
        }
        .chapter-btn.unlocked {
            border-color: var(--accent); color: #fff; cursor: pointer;
            background: linear-gradient(90deg, rgba(0, 255, 65, 0.05), transparent);
        }
        .chapter-btn.unlocked:hover {
            background: var(--accent); color: #000; transform: scale(1.02);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.4);
        }
        .chapter-btn .status { font-family: 'Fira Code'; font-size: 12px; opacity: 0.7; }
        
        /* Inventory Styles */
        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 15px; }
        .inv-item {
            background: rgba(255,255,255,0.05); border: 1px solid #444;
            border-radius: 4px; padding: 15px 10px; text-align: center;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .inv-icon { font-size: 28px; }
        .inv-name { font-size: 13px; color: #ddd; }

        /* Settings Styles */
        .setting-item { margin-bottom: 25px; padding: 0 10px; }
        .setting-item label { display: block; color: #aaa; margin-bottom: 10px; font-family: 'Noto Serif TC', serif; font-size: 14px; }
        .setting-item input[type=range] { width: 100%; accent-color: var(--primary); cursor: pointer; }

        /* 神器介面 */
        #artifact-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.98); z-index: 300;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            animation: fadeIn 1s;
        }
        .artifact-img { 
            width: 150px; height: 150px; object-fit: contain; 
            filter: drop-shadow(0 0 30px var(--primary)); 
            animation: float 3s infinite ease-in-out, glowPulse 2s infinite alternate; 
        }
        .artifact-title { font-family: 'Cinzel'; color: var(--primary); font-size: 24px; margin-top: 20px; text-shadow: 0 0 10px var(--primary); }
        .artifact-desc { color: #aaa; font-size: 14px; margin-top: 10px; max-width: 80%; text-align: center; line-height: 1.6; }

        @keyframes glitch { 0% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 40% { transform: translate(-2px, -2px); } 60% { transform: translate(2px, 2px); } 80% { transform: translate(2px, -2px); } 100% { transform: translate(0); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0, 255, 65, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(0, 255, 65, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 255, 65, 0); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes glowPulse {
            0% { filter: drop-shadow(0 0 20px var(--primary)); }
            100% { filter: drop-shadow(0 0 60px var(--primary)) brightness(1.5); }
        }
    </style>
</head>
<body>

    <div id="game-stage">
        <audio id="bgm-crisis" loop volume="0"><source src="https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E9%9F%B3%E6%A8%82%E7%B4%A0%E6%9D%90/%E5%BA%8F%E7%AB%A0/%E6%9B%B2%E7%9B%AE%20A%EF%BC%9A%E7%B3%BB%E7%B5%B1%E5%B4%A9%E6%BD%B0%20(%E9%96%8B%E5%A0%B4%E7%94%A8).mp3"></audio>
        <audio id="bgm-king" loop volume="0"><source src="https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E9%9F%B3%E6%A8%82%E7%B4%A0%E6%9D%90/%E5%BA%8F%E7%AB%A0/%E6%9B%B2%E7%9B%AE%20B%EF%BC%9A%E5%9C%8B%E7%8E%8B%E7%9A%84%E5%AF%A9%E5%88%A4%20(%E7%B6%AD%E7%B4%8D%E6%89%98%E7%99%BB%E5%A0%B4%E7%94%A8).mp3"></audio>
        <audio id="bgm-stage1" loop volume="0"><source src="https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E9%9F%B3%E6%A8%82%E7%B4%A0%E6%9D%90/%E4%B8%BBbgm/%E7%AC%AC%E4%B8%80%E7%AB%A0_%E7%84%A6%E6%85%AE%E7%9A%84%E8%A1%8C%E7%A8%8B%E8%A1%A8.mp3"></audio>
        <audio id="sfx-teleport" src="https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E9%9F%B3%E6%A8%82%E7%B4%A0%E6%9D%90/%E5%82%B3%E9%80%81%E9%96%80%E9%9F%B3%E6%95%88.mp3"></audio>
        <audio id="sfx-fall" src="https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E9%9F%B3%E6%A8%82%E7%B4%A0%E6%9D%90/%E6%8E%89%E4%B8%8B%E5%8E%BB.mp3"></audio>
        <audio id="sfx-success" src="https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E9%9F%B3%E6%A8%82%E7%B4%A0%E6%9D%90/%E7%AC%AC%E4%B8%80%E7%AB%A0_%E5%9F%B7%E8%A1%8C%E6%88%90%E5%8A%9F.mp3"></audio>
        <audio id="sfx-drag" crossorigin="anonymous" src="https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E9%9F%B3%E6%A8%82%E7%B4%A0%E6%9D%90/%E7%AC%AC%E4%B8%80%E7%AB%A0_%E9%BB%9E%E6%93%8A%E6%96%B9%E5%A1%8A.mp3"></audio>
        <audio id="sfx-item-get" src="https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E9%9F%B3%E6%A8%82%E7%B4%A0%E6%9D%90/%E7%8D%B2%E5%BE%97%E9%81%93%E5%85%B7.mp3"></audio>

        <div id="bg-error" class="bg-layer"></div>
        <div id="bg-room" class="bg-layer"></div>
        <div id="bg-hole" class="bg-layer"></div>
        <div id="bg-door-closed" class="bg-layer"></div>
        <div id="bg-hallway" class="bg-layer"></div>
        <div id="bg-final-gate" class="bg-layer"></div>

        <div class="visual-container">
            <div id="error-msg" class="error-popup">⚠ LOGIC ERROR<br>Sequence Mismatch</div>
            <div id="success-msg" class="success-popup">✓ SYSTEM NORMAL</div>
        </div>

        <div class="char-layer">
            <img id="char-hassel" class="char-img" src="https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E9%81%8A%E6%88%B2%E4%BA%BA%E7%89%A9%E7%AB%8B%E7%B9%AA/%E5%93%88%E8%98%87/%E5%93%88%E8%98%87_%E6%AD%A3%E5%B8%B8.png">
            <img id="char-venator" class="char-img" src="https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E9%81%8A%E6%88%B2%E4%BA%BA%E7%89%A9%E7%AB%8B%E7%B9%AA/%E7%B6%AD%E7%B4%8D%E6%89%98/%E7%B6%AD%E7%B4%8D%E6%89%98_%E6%AD%A3%E5%B8%B8.png">
            <img id="char-narcissus" class="char-img" src="https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E9%81%8A%E6%88%B2%E4%BA%BA%E7%89%A9%E7%AB%8B%E7%B9%AA/%E7%B4%8D%E5%B8%8C%E7%91%9F%E6%96%AF/%E7%B4%8D%E5%B8%8C%E7%91%9F%E6%96%AF_%E6%AD%A3%E5%B8%B8.png">
            <img id="char-kleion" class="char-img" src="https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E9%81%8A%E6%88%B2%E4%BA%BA%E7%89%A9%E7%AB%8B%E7%B9%AA/%E5%85%8B%E9%87%8C%E6%98%82/%E5%85%8B%E9%87%8C%E6%98%82_%E6%AD%A3%E5%B8%B8.png">
        </div>

        <div id="flash-overlay"></div>

        <div class="dialogue-wrapper" id="dialogue-box" onclick="playClickSound(); nextScript()">
            <div class="name-tag" id="d-name">系統</div>
            <div class="skip-btn" id="skip-btn" onclick="event.stopPropagation(); playClickSound(); toggleSkip()">SKIP >></div>
            <div class="dialogue-box">
                <div class="dialogue-text" id="d-text">...</div>
                <div class="next-arrow"><span>✿</span>NEXT</div>
            </div>
        </div>

        <div class="vision-btn" id="btn-vision" onclick="playClickSound(); openEditor()" style="display:none;">&lt;/&gt;</div>

        <div id="code-editor">
            <div class="editor-header">
                <span id="file-name">SCRIPT.js</span>
                <span onclick="playClickSound(); closeEditor()" style="cursor:pointer">▼ HIDE</span>
            </div>
            <div class="code-list" id="code-list"></div>
            <button class="run-btn" id="run-btn" onclick="playClickSound(); runSequence()">▶ RUN SEQUENCE</button>
        </div>

        <div class="system-menu-btn" onclick="playClickSound(); openSystemMenu()">☰</div>

        <div id="system-menu">
            <div class="sys-menu-container">
                <button class="btn-close-menu" onclick="playClickSound(); closeSystemMenu()">X</button>
                <div class="sys-tabs">
                    <button class="sys-tab active" onclick="playClickSound(); switchTab('chapters')">章節選擇</button>
                    <button class="sys-tab" onclick="playClickSound(); switchTab('inventory')">背包物品</button>
                    <button class="sys-tab" onclick="playClickSound(); switchTab('settings')">系統設定</button>
                </div>
                <div id="tab-chapters" class="sys-content active"><div class="chapter-list" id="chapter-list-container"></div></div>
                <div id="tab-inventory" class="sys-content">
                    <div class="inventory-grid" id="inventory-list"></div>
                    <div id="inventory-desc" style="margin-top:20px; padding:15px; background:rgba(255,255,255,0.05); border:1px solid var(--primary); border-radius:4px; font-size:13px; color:#ccc; line-height:1.6; white-space: pre-wrap; display:none; box-shadow: inset 0 0 20px rgba(0,0,0,0.5);"></div>
                </div>
                <div id="tab-settings" class="sys-content">
                    <div class="setting-item"><label>音樂音量 (BGM)</label><input type="range" min="0" max="1" step="0.05" value="0.6" oninput="setBgmVolume(this.value)"></div>
                    <div class="setting-item"><label>音效音量 (SFX)</label><input type="range" min="0" max="1" step="0.05" value="1.0" oninput="setSfxVolume(this.value)"></div>
                </div>
            </div>
        </div>

        <div id="artifact-overlay" onclick="playClickSound(); closeArtifact()">
            <img class="artifact-img" src="https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E5%A0%B4%E6%99%AF%E7%BE%8E%E8%A1%93%E7%B4%A0%E6%9D%90/%E7%AC%AC%E4%B8%80%E7%AB%A0/%E7%99%BC%E6%A2%9D%E6%87%B7%E9%8C%B6.png">
            <div class="artifact-title">GET: 懷錶發條</div>
            <div class="artifact-desc">控制「順序」的權限模組。<br>沒有它，程式的時間將永遠停滯。</div>
            <div style="color:#666; margin-top:20px; font-size:12px;">(點擊關閉)</div>
        </div>

        <div id="start-screen">
            <div class="start-menu-card">
                <h1 style="font-family:'Cinzel'; color:var(--primary); font-size:48px; text-shadow:0 0 20px rgba(212, 175, 55, 0.5); text-align:center; line-height: 1.2; margin-bottom: 10px;">
                    Code In<br>Wonderland
                </h1>
                <div style="color: #aaa; font-size: 12px; margin-bottom: 40px; letter-spacing: 4px; font-family: 'Fira Code';">SYSTEM_REBOOT_SEQUENCE</div>
                
                <button class="btn-start" onclick="playClickSound(); startGame()">NEW GAME</button>
                <button class="btn-start" style="border-color:var(--accent); color:var(--accent);" onclick="playClickSound(); openSystemMenu()">CHAPTERS</button>
            </div>
        </div>
    </div>

    <script>
        let index = 0;
        let isPlaying = false;
        let currentBgm = null;
        // 打字機變數
        let typingTimer = null;
        let isTyping = false;
        let currentText = "";
        let audioCtx = null; // AudioContext for SFX
        let isSkipping = false; // 跳過模式狀態
        let gameMode = 'prologue'; // prologue, level-intro, level-editor, level-success
        let unlockedProgress = parseInt(localStorage.getItem('wonderland_progress')) || 0; // 0: Prologue, 1: Lvl1, 2: Lvl2...
        let playerInventory = JSON.parse(localStorage.getItem('wonderland_inventory')) || [];
        let dragNodeSource = null; // 用於增強拖曳音效
        let globalBgmVolume = 0.6;
        let globalSfxVolume = 1.0;
        let dragGainNode = null;

        // --- 角色表情資源設定 (請在此處替換真實圖片 URL) ---
        const charAssets = {
            'char-hassel': {
                'default': 'https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E9%81%8A%E6%88%B2%E4%BA%BA%E7%89%A9%E7%AB%8B%E7%B9%AA/%E5%93%88%E8%98%87/%E5%93%88%E8%98%87_%E6%AD%A3%E5%B8%B8.png',
                'panic': 'https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E9%81%8A%E6%88%B2%E4%BA%BA%E7%89%A9%E7%AB%8B%E7%B9%AA/%E5%93%88%E8%98%87/%E5%93%88%E8%98%87_%E6%AD%A3%E5%B8%B8.png',
                'serious': 'https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E9%81%8A%E6%88%B2%E4%BA%BA%E7%89%A9%E7%AB%8B%E7%B9%AA/%E5%93%88%E8%98%87/%E5%93%88%E8%98%87_%E6%AD%A3%E5%B8%B8.png'
            },
            'char-venator': {
                'default': 'https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E9%81%8A%E6%88%B2%E4%BA%BA%E7%89%A9%E7%AB%8B%E7%B9%AA/%E7%B6%AD%E7%B4%8D%E6%89%98/%E7%B6%AD%E7%B4%8D%E6%89%98_%E6%AD%A3%E5%B8%B8.png',
                'serious': 'https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E9%81%8A%E6%88%B2%E4%BA%BA%E7%89%A9%E7%AB%8B%E7%B9%AA/%E7%B6%AD%E7%B4%8D%E6%89%98/%E7%B6%AD%E7%B4%8D%E6%89%98_%E5%9A%B4%E8%82%85.png'
            },
            'char-narcissus': {
                'default': 'https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E9%81%8A%E6%88%B2%E4%BA%BA%E7%89%A9%E7%AB%8B%E7%B9%AA/%E7%B4%8D%E5%B8%8C%E7%91%9F%E6%96%AF/%E7%B4%8D%E5%B8%8C%E7%91%9F%E6%96%AF_%E6%AD%A3%E5%B8%B8.png',
                'smile': 'https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E9%81%8A%E6%88%B2%E4%BA%BA%E7%89%A9%E7%AB%8B%E7%B9%AA/%E7%B4%8D%E5%B8%8C%E7%91%9F%E6%96%AF/%E7%B4%8D%E5%B8%8C%E7%91%9F%E6%96%AF_%E6%AD%A3%E5%B8%B8.png'
            },
            'char-kleion': {
                'default': 'https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E9%81%8A%E6%88%B2%E4%BA%BA%E7%89%A9%E7%AB%8B%E7%B9%AA/%E5%85%8B%E9%87%8C%E6%98%82/%E5%85%8B%E9%87%8C%E6%98%82_%E6%AD%A3%E5%B8%B8.png',
                'shock': 'https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E9%81%8A%E6%88%B2%E4%BA%BA%E7%89%A9%E7%AB%8B%E7%B9%AA/%E5%85%8B%E9%87%8C%E6%98%82/%E5%85%8B%E9%87%8C%E6%98%82_%E7%96%91%E6%83%91.png'
            }
        };

        // --- 第一章關卡資料 (已轉換為您的 UI 格式) ---
        const levels = {
            1: {
                title: "Stage 1-1: The Gate",
                file: "DOOR_LOGIC.js",
                blocks: [
                    { id: 'enter', text: 'Enter_Gate() // 進入大門', type: 'key', order: 2 },
                    { id: 'open', text: 'Open_Gate() // 開啟大門', type: 'key', order: 1 }
                ],
                solutionLength: 2,
                intro: [
                    { n: "克里昂", t: "（揉著腰從地上爬起來）痛... 這裡就是兔洞底下？地板硬得跟我的命一樣苦。還有，為什麼地板在發光？", chars: [{id:'char-kleion', pos:'pos-center', state:'active', face:'shock'}] },
                    { n: "哈蘇", t: "（在巨大的電子閘門前來回踱步）錯誤。錯誤。行程表延遲 12 秒。為什麼進不去？參數明明都設定好了。", chars: [{id:'char-hassel', pos:'pos-center', state:'active', face:'panic'}] },
                    { n: "哈蘇", t: "（對著空氣自言自語）依照腳本，我應該在 10:05:00 穿過大門。現在已經 10:05:12 了！這不在預算內！", chars: [{id:'char-hassel', pos:'pos-center', state:'active', face:'panic'}] },
                    { n: "克里昂", t: "那個... 雖然我不懂這裡的規矩，但你一直在撞牆。是不是應該先『開門』再『進去』？", chars: [{id:'char-kleion', pos:'pos-left', state:'active'}, {id:'char-hassel', pos:'pos-right', state:'dim'}] },
                    { n: "哈蘇", t: "（猛然回頭，眼鏡反光）你說什麼？我是系統管理員，我怎麼可能犯這種低級... 等等。", chars: [{id:'char-hassel', pos:'pos-right', state:'active', face:'serious'}, {id:'char-kleion', pos:'pos-left', state:'dim'}] },
                    { n: "哈蘇", t: "（臉色發白）我的執行緒... 亂掉了？這不可能。愛麗絲，快幫我看看，我的邏輯迴路是不是燒壞了？", chars: [{id:'char-hassel', pos:'pos-right', state:'active', face:'panic'}, {id:'char-kleion', pos:'pos-left', state:'dim'}] },
                    { n: "系統", t: "【教學】哈蘇的腦內邏輯混亂了。請拖曳指令，將它們排成符合常理的順序 (由上往下執行)。", chars: [] }
                ],
                success: [
                    { n: "系統", t: ">>> 邏輯修正。大門開啟。", chars: [] },
                    { n: "哈蘇", t: "開了？居然真的是順序問題... 咳，這只是偶發性的系統延遲，絕對不是我忘了寫分號。", chars: [{id:'char-hassel', pos:'pos-center', state:'active', face:'default'}] },
                    { n: "克里昂", t: "（小聲）這只是常識吧...", chars: [{id:'char-kleion', pos:'pos-center', state:'active', face:'default'}] }
                ]
            },
            2: {
                title: "Stage 1-2: Identity",
                file: "PREPARATION.js",
                blocks: [
                    { id: 'jump', text: 'Jump() // 跳進通道', type: 'key', order: 4 },
                    { id: 'announce', text: 'Announce() // 宣告身分', type: 'key', order: 3 },
                    { id: 'check', text: 'Check_Time() // 確認時間', type: 'key', order: 1 },
                    { id: 'adjust', text: 'Adjust_Tie() // 整理領結', type: 'key', order: 2 }
                ],
                solutionLength: 4,
                intro: [
                    { n: "哈蘇", t: "別鬆懈。接下來要通過『身份驗證區』。我必須保持完美的儀態，否則會被防火牆攔截。", chars: [{id:'char-hassel', pos:'pos-center', state:'active', face:'serious'}] },
                    { n: "哈蘇", t: "但我現在腦子很亂... 記憶體洩漏了... 我應該先整理領結？還是先看時間？如果順序錯了，我會被系統判定為『衣冠不整的入侵者』而刪除。", chars: [{id:'char-hassel', pos:'pos-center', state:'active', face:'panic'}] },
                    { n: "克里昂", t: "你這兔子也太神經質了吧... 好吧，深呼吸。先確認時間，整理儀容，宣告身分，然後跳下去。這樣最帥。", chars: [{id:'char-kleion', pos:'pos-center', state:'active'}] },
                    { n: "哈蘇", t: "這聽起來很合理。愛麗絲，幫我把這個順序寫進我的執行緒裡。別弄錯，我不想被電擊。", chars: [{id:'char-hassel', pos:'pos-right', state:'active'}, {id:'char-kleion', pos:'pos-left', state:'dim'}] }
                ],
                success: [
                    { n: "系統", t: ">>> 執行成功。儀態完美。", chars: [] },
                    { n: "哈蘇", t: "（整理領結，深吸一口氣）很好。誤差值修正完畢。感覺變流暢了。我們已經追回了 5 秒的進度。", chars: [{id:'char-hassel', pos:'pos-center', state:'active', face:'default'}] }
                ]
            },
            3: {
                title: "Stage 1-3: Final Sprint",
                file: "FINAL_SPRINT.js",
                blocks: [
                    { id: 'run', text: 'Sprint() // 衝刺', type: 'key', order: 2 },
                    { id: 'panic', text: 'Panic() // 驚慌失措', type: 'trap', msg: "哈蘇：不准驚慌！這不在行程內！" },
                    { id: 'log', text: 'Log_Start() // 紀錄開始', type: 'key', order: 1 },
                    { id: 'target', text: 'Set_Target() // 設定座標', type: 'key', order: 3 }
                ],
                solutionLength: 3,
                intro: [
                    { n: "哈蘇", t: "最後一步。我們要衝進去見維納托大人。這是最後的衝刺，絕對不能有任何多餘的動作。", chars: [{id:'char-hassel', pos:'pos-center', state:'active', face:'serious'}] },
                    { n: "克里昂", t: "等等，你日誌裡怎麼有個『Panic() (驚慌失措)』的指令？這也是行程的一部分？", chars: [{id:'char-kleion', pos:'pos-left', state:'active'}, {id:'char-hassel', pos:'pos-right', state:'dim'}] },
                    { n: "哈蘇", t: "那是試用的殘留代碼！絕對不能執行那個！", chars: [{id:'char-hassel', pos:'pos-right', state:'active', face:'panic'}, {id:'char-kleion', pos:'pos-left', state:'dim'}] },
                    { n: "克里昂", t: "懂了。這就是所謂的 Bug 吧。把它丟到最後面無視掉對吧？", chars: [{id:'char-kleion', pos:'pos-left', state:'active'}, {id:'char-hassel', pos:'pos-right', state:'dim'}] }
                ],
                success: [
                    { n: "系統", t: ">>> 執行成功。路徑暢通。", chars: [] },
                    { n: "哈蘇", t: "呼... 終於正常了。看來你的邏輯能力勉強及格。走吧，加冕禮要開始了。", chars: [{id:'char-hassel', pos:'pos-center', state:'active', face:'default'}] },
                    { n: "克里昂", t: "（停下腳步）等一下。我幫你修好了腦袋，現在該你回答我了。", chars: [{id:'char-kleion', pos:'pos-center', state:'active'}] },
                    { n: "克里昂", t: "這裡是哪？為什麼綁架我？我要怎麼回家？我明天還要上班啊！我的報告還沒存檔啊！", chars: [{id:'char-kleion', pos:'pos-center', state:'active', face:'shock'}] },
                    { n: "哈蘇", t: "回家？如果你現在離開，這個世界就會因為『缺乏愛麗絲』而崩潰。也就是格式化。", chars: [{id:'char-hassel', pos:'pos-center', state:'active', face:'serious'}] },
                    { n: "哈蘇", t: "你原本的世界也會受到波及。Excel 閃退只是開始，你的存在數據也會被抹消。", chars: [{id:'char-hassel', pos:'pos-center', state:'active'}] },
                    { n: "系統", t: "叮——咚。(一個金屬物體從開啟的門縫中掉了下來)", chars: [] },
                    { n: "哈蘇", t: "（撿起物體）拿著這個。", chars: [{id:'char-hassel', pos:'pos-center', state:'active'}] },
                    { n: "克里昂", t: "這是什麼？加班費？", chars: [{id:'char-kleion', pos:'pos-center', state:'active'}] },
                    { n: "哈蘇", t: "這是【懷錶發條】，我的核心權限模組。剛剛就是它卡住了門的邏輯迴路。", chars: [{id:'char-hassel', pos:'pos-center', state:'active'}] },
                    { n: "哈蘇", t: "這裡是由代碼構成的『崩壞仙境』。想回家？唯一的路就是完成『加冕禮』，讓程式跑完。", chars: [{id:'char-hassel', pos:'pos-center', state:'active'}] },
                    { n: "哈蘇", t: "這個發條能讓你控制事物的【順序 (Sequence)】。沒有它，我們連第一步都走不出去。收好它，這是你身為實習生的識別證。", chars: [{id:'char-hassel', pos:'pos-center', state:'active'}] },
                    { n: "神器", t: "獲得神器：懷錶發條", chars: [] }, // 觸發神器介面
                    { n: "克里昂", t: "（握緊發條，嘆氣）...如果不演完，我就回不去，是這個意思吧？好，我演。但事後記得給我雙倍薪水。", chars: [{id:'char-kleion', pos:'pos-center', state:'active'}] }
                ]
            }
        };

        // --- 序章劇本資料 ---
        const prologueScript = [
            // 場景 1
            { bg: 'bg-error', music: 'crisis', chars: [], n: "系統", t: "【警告】核心變數遺失。錯誤代碼：404。" },
            { chars: [], n: "系統", t: "檢測到檔案 'Alice.chr' (愛麗絲) 已從資料庫中物理刪除。" },
            { chars: [], n: "系統", t: "邏輯鏈斷裂。加冕禮程序無法啟動。正在嘗試從備份伺服器復原... 失敗。" },
            { chars: [], n: "系統", t: "嚴重警告：若加冕禮無法在 00:05:00 內執行，本世界將被判定為無效數據，並執行強制格式化 (Format)。" },
            
            // 場景 2: 哈蘇獨白 (居中)
            { bg: 'bg-room', 
              chars: [{id:'char-hassel', pos:'pos-center', state:'active'}], 
              n: "哈蘇", t: "報告。發生極度異常狀況。行程表上... 沒有這條紀錄。" },
            
            { chars: [{id:'char-hassel', pos:'pos-center', state:'active'}], 
              n: "哈蘇", t: "（快速翻閱筆記）10:00 是加冕禮，是維納托大人最重要的登基運算。但是啟動鑰匙...『愛麗絲』不見了？" },
            
            { chars: [{id:'char-hassel', pos:'pos-center', state:'active'}], 
              n: "哈蘇", t: "這不在紀錄內。如果沒有『愛麗絲』走完劇情，整個仙境的邏輯迴路都會燒毀。我們全部都會被刪除..." },
            
            // 維納托登場 (左)，哈蘇 (右，變暗)
            { music: 'king', 
              chars: [
                  {id:'char-venator', pos:'pos-left', state:'active', face: 'default'},
                  {id:'char-hassel', pos:'pos-right', state:'dim'} 
              ],
              n: "維納托", t: "哈蘇。" },
            
            // 哈蘇說話 (變亮)，維納托 (變暗)
            { chars: [
                  {id:'char-venator', pos:'pos-left', state:'dim'},
                  {id:'char-hassel', pos:'pos-right', state:'active'}
              ], 
              n: "哈蘇", t: "（立正）是！維納托大人！" },
            
            { chars: [
                  {id:'char-venator', pos:'pos-left', state:'active', face: 'serious'},
                  {id:'char-hassel', pos:'pos-right', state:'dim'}
              ],
              n: "維納托", t: "你在那裡碎碎念什麼？本王剛剛好像聽到了『錯誤』、『消失』這些不優雅的詞彙？" },
            
            { n: "維納托", t: "你知道今天是什麼日子嗎？這是本王——尼古拉斯．維納托，成為這世界唯一絕對核心的日子。" },

            // 納希瑟斯登場 (右)，哈蘇 (退場)
            { chars: [
                  {id:'char-venator', pos:'pos-left', state:'dim'},
                  {id:'char-narcissus', pos:'pos-right', state:'active'} 
              ],
              n: "納希瑟斯", t: "（微笑著擦拭武器）維納托先生，我看這隻兔子好像當機了。需要我幫您『清理垃圾』嗎？" },
            
            { n: "納希瑟斯", t: "為了您的加冕禮，任何瑕疵都應該被修正。物理上的修正。" },

            // 哈蘇回來 (右)，納希瑟斯 (退場)
            { chars: [
                  {id:'char-venator', pos:'pos-left', state:'dim'},
                  {id:'char-hassel', pos:'pos-right', state:'active'} 
              ],
              n: "哈蘇", t: "否定！不需要修正！根據計算，只要重新輸入一個『變數』即可解決！" },
            
            { n: "哈蘇", t: "只要找到一個符合邏輯特徵的替代品，填補進『愛麗絲』的空位，程式就能繼續運行！" },

            { chars: [
                  {id:'char-venator', pos:'pos-left', state:'active', face: 'serious'},
                  {id:'char-hassel', pos:'pos-right', state:'dim'}
              ],
              n: "維納托", t: "哼。變數？替代品？本王不在乎過程。" },
            
            { n: "維納托", t: "只要有人能走完流程，在終點大聲讚美本王，是誰都無所謂。貓也好，狗也好，人類也好。" },
            
            { n: "維納托", t: "給你 10 秒鐘。解決這個 Bug。不然本王就拆了你的硬碟，拿去墊桌腳。" },
            
            // 只剩哈蘇 (中間)
            { music: 'crisis', 
              chars: [{id:'char-hassel', pos:'pos-center', state:'active'}],
              n: "哈蘇", t: "收到。正在掃描外部資料庫... 搜尋符合邏輯的個體... (快速運算中)" },
            
            { chars: [{id:'char-hassel', pos:'pos-center', state:'active'}],
              n: "哈蘇", t: "目標鎖定。ID: Kleion (克里昂)。職業：社畜。邏輯判斷：正常。耐摔度：高。對不合理現象的接受度：高。" },
            
            { chars: [{id:'char-hassel', pos:'pos-center', state:'active'}],
              n: "哈蘇", t: "符合度 98%。雖然是男性，但系統判定可以兼容。執行指令：Force_Import(Kleion)。" },
            
            // 傳送，克里昂登場 (中)，哈蘇移到 (右)
            { effect: 'teleport', 
              chars: [
                  {id:'char-hassel', pos:'pos-right', state:'dim'},
                  {id:'char-kleion', pos:'pos-center', state:'active', face: 'shock'}
              ],
              n: "系統", t: ">>> 正在強制覆寫現實數據... 傳送開始。" },
            
            { chars: [
                  {id:'char-hassel', pos:'pos-right', state:'dim'},
                  {id:'char-kleion', pos:'pos-center', state:'active', face: 'shock'}
              ],
              n: "克里昂", t: "......那個，不好意思，我的 Excel 剛剛是不是閃退了？我報告還沒存檔欸..." },
            
            { chars: [
                  {id:'char-hassel', pos:'pos-right', state:'active'},
                  {id:'char-kleion', pos:'pos-left', state:'dim'}
              ],
              n: "哈蘇", t: "（紀錄中）新任愛麗絲已上線。時間誤差 0.05 秒。可接受範圍。" },
            
            { chars: [
                  {id:'char-hassel', pos:'pos-right', state:'dim'},
                  {id:'char-kleion', pos:'pos-center', state:'active', face: 'shock'}
              ],
              n: "克里昂", t: "等等... 這裡是哪裡？為什麼你長得像粉筆一樣白？還有耳朵？這是什麼沉浸式加班地獄嗎？" },
            
            { chars: [
                  {id:'char-hassel', pos:'pos-right', state:'active'},
                  {id:'char-kleion', pos:'pos-left', state:'dim'}
              ],
              n: "哈蘇", t: "我是紀錄員哈蘇。你現在是愛麗絲了。這是通知，不是協商。你的任務是完成加冕禮，否則這個世界連同你的報告都會消失。" },
            
            { chars: [
                  {id:'char-hassel', pos:'pos-right', state:'dim'},
                  {id:'char-kleion', pos:'pos-center', state:'active', face: 'shock'}
              ],
              n: "克里昂", t: "蛤？愛麗絲？你看清楚，我是男的！而且我有名字，我叫克里昂！我要回家！" },
            
            { chars: [
                  {id:'char-hassel', pos:'pos-right', state:'active'},
                  {id:'char-kleion', pos:'pos-left', state:'dim'}
              ],
              n: "哈蘇", t: "性別參數已忽略。行程表延遲警告。沒時間解釋了，請立刻前往兔洞。" },
            
            // 墜落
            { bg: 'bg-hole', 
              chars: [{id:'char-kleion', pos:'pos-center', state:'active', face: 'shock'}],
              effect: 'fall', n: "克里昂", t: "等等，你說的兔洞該不會是——哇啊啊啊啊啊——這不符合勞基法啊啊啊——" },
            
            { chars: [], n: "系統", t: "偵測到新使用者。正在強制安裝插件：【Code Vision (數據視界)】..." },
            { chars: [], n: "系統", t: "安裝完成。歡迎來到崩壞仙境。" },
        ];

        // 當前執行的劇本
        let currentScript = prologueScript;
        let currentLvl = 1;

        // --- 核心邏輯 ---

        function saveProgress(p) {
            if(p > unlockedProgress) {
                unlockedProgress = p;
                localStorage.setItem('wonderland_progress', unlockedProgress);
            }
        }

        function startGame() {
            // NEW GAME: 重置所有狀態
            playerInventory = [];
            unlockedProgress = 0; // 如果希望新遊戲不影響已解鎖章節，可註解此行；若希望完全重來則保留
            
            // 清除存檔 (可選，視需求而定)
            localStorage.removeItem('wonderland_inventory');
            // localStorage.removeItem('wonderland_progress'); // 通常保留章節解鎖狀態比較友善

            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('dialogue-box').style.display = 'block';
            isPlaying = true;
            document.getElementById('bgm-crisis').volume = globalBgmVolume;
            document.getElementById('bgm-king').volume = globalBgmVolume;
            initAudio(); // 初始化音效引擎
            
            // 重置為序章
            loadPrologue();
        }

        function nextScript() {
            if(!isPlaying) return;
            
            // 如果正在打字，直接顯示全部文字
            if(isTyping) {
                completeTyping();
                return;
            }

            index++;
            if(index >= currentScript.length) {
                // 劇本結束時的狀態切換
                if (gameMode === 'prologue') {
                    saveProgress(1); // 解鎖第一關
                    // 優化轉場：白光淡入淡出
                    const flash = document.getElementById('flash-overlay');
                    flash.style.transition = 'opacity 1s ease-in';
                    flash.style.opacity = 1;
                    
                    setTimeout(() => {
                        initStage1();
                        // 切換完畢後淡出
                        setTimeout(() => {
                            flash.style.transition = 'opacity 1.5s ease-out';
                            flash.style.opacity = 0;
                        }, 100);
                    }, 1000);
                    
                } else if (gameMode === 'level-intro') {
                    startPuzzle();
                } else if (gameMode === 'level-success') {
                    nextLevel();
                }
                return;
            }
            updateGame();
        }

        function updateGame() {
            const step = currentScript[index];
            
            // 特殊事件：獲得神器
            if(step.n === "神器") {
                document.getElementById('artifact-overlay').style.display = 'flex';
                document.getElementById('sfx-item-get').play();
                // 加入背包
                if (!playerInventory.includes("懷錶發條")) {
                    playerInventory.push("懷錶發條");
                    localStorage.setItem('wonderland_inventory', JSON.stringify(playerInventory));
                }
                // 暫時隱藏對話框
                document.getElementById('dialogue-box').style.display = 'none';
                return; 
            }
            
            // 1. 文字更新
            document.getElementById('d-name').innerText = step.n;
            startTyping(step.t);

            // V7: 名字標籤顏色 (修正版)
            const nameMap = {
                '哈蘇': '#e0e0e0', 
                '維納托': '#00008b', /* 深藍 */
                '納希瑟斯': '#800080', /* 紫 */
                '克里昂': '#ff4500', /* 紅橙色 */
                '系統': '#d4af37'
            };
            const color = nameMap[step.n] || '#d4af37';
            // 設定 CSS 變數，讓樣式表使用
            document.querySelector('.name-tag').style.setProperty('--char-color', color);


            // 2. 背景切換
            if(step.bg) {
                document.querySelectorAll('.bg-layer').forEach(bg => bg.style.opacity = 0);
                document.getElementById(step.bg).style.opacity = 1;
            }

            // 3. 音樂切換
            if(step.music) fadeMusic(step.music);

            // 4. 角色管理
            // 優化：只在 step.chars 存在時更新，且不強制重置所有角色以避免閃爍
            if (step.chars) {
                // 建立目標狀態 Map
                const targetState = {};
                step.chars.forEach(c => targetState[c.id] = c);

                document.querySelectorAll('.char-img').forEach(img => {
                    // 移除一次性動畫 class
                    img.classList.remove('anim-teleport', 'anim-fall');

                    if (targetState[img.id]) {
                        // 如果在目標列表中，直接設定 class (避免先 remove 造成的閃爍)
                        const info = targetState[img.id];
                        img.className = `char-img ${info.pos} ${info.state}`;
                        img.style.opacity = 1;

                        // 表情切換邏輯
                        if (info.face && charAssets[img.id] && charAssets[img.id][info.face]) {
                            img.src = charAssets[img.id][info.face];
                        }
                    } else {
                        // 不在目標列表中，隱藏
                        img.style.opacity = 0;
                        // FIX: 保留位置 class (pos-*) 避免淡出時瞬移到中間
                        img.classList.remove('active', 'dim');
                    }
                });
            }

            // 5. 特效處理
            if (step.effect === 'teleport') {
                const flash = document.getElementById('flash-overlay');
                flash.style.animation = 'none';
                flash.offsetHeight; 
                flash.style.animation = 'flashAnim 0.5s forwards';
                document.getElementById('sfx-teleport').play();
                
                const activeChar = document.querySelector('.char-img.active');
                if(activeChar) activeChar.classList.add('anim-teleport');
            } else if (step.effect === 'fall') {
                const activeChar = document.querySelector('.char-img.active');
                document.getElementById('sfx-fall').play();
                if(activeChar) activeChar.classList.add('anim-fall');
            }
        }

        function fadeMusic(newBgmId) {
            const newBgm = document.getElementById('bgm-' + newBgmId);
            if (currentBgm === newBgm) return;

            if (currentBgm) {
                let fadeOut = setInterval(() => {
                    if (currentBgm.volume > 0.1) currentBgm.volume -= 0.1;
                    else {
                        clearInterval(fadeOut);
                        currentBgm.pause();
                        currentBgm.currentTime = 0;
                        currentBgm.volume = globalBgmVolume;
                        playNewBgm(newBgm);
                    }
                }, 100);
            } else {
                playNewBgm(newBgm);
            }
        }

        function playNewBgm(newBgm) {
            newBgm.volume = globalBgmVolume;
            newBgm.play();
            currentBgm = newBgm;
        }

        // --- 音效系統 ---
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            
            // 初始化拖曳音效增強 (Boost Volume)
            if (!dragNodeSource) {
                try {
                    const dragAudio = document.getElementById('sfx-drag');
                    dragNodeSource = audioCtx.createMediaElementSource(dragAudio);
                    const gainNode = audioCtx.createGain();
                    gainNode.gain.value = 3.0 * globalSfxVolume; // 3倍音量 * 設定值
                    dragNodeSource.connect(gainNode).connect(audioCtx.destination);
                    dragGainNode = gainNode;
                } catch(e) { console.log("Audio routing error:", e); }
            }
        }

        function playTypeSound() {
            if (!audioCtx) return;
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            
            // 輕微的打字機滴答聲
            osc.type = 'square';
            osc.frequency.setValueAtTime(800, t);
            osc.frequency.exponentialRampToValueAtTime(100, t + 0.03);
            
            gain.gain.setValueAtTime(0.1 * globalSfxVolume, t);
            gain.gain.exponentialRampToValueAtTime(0.001, t + 0.03);
            
            osc.start(t); osc.stop(t + 0.03);
        }

        function playClickSound() {
            initAudio();
            if (!audioCtx) return;
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(600, t);
            gain.gain.setValueAtTime(0.2 * globalSfxVolume, t);
            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.05);
            osc.start(t);
            osc.stop(t + 0.05);
        }

        // --- 打字機效果函數 ---
        function startTyping(text) {
            const textBox = document.getElementById('d-text');
            textBox.innerText = "";
            currentText = text;
            isTyping = true;
            
            // 如果處於跳過模式，直接顯示並結束
            if(isSkipping) {
                textBox.innerText = text;
                isTyping = false;
                return;
            }

            let i = 0;
            if(typingTimer) clearInterval(typingTimer);
            
            typingTimer = setInterval(() => {
                textBox.innerText += text.charAt(i);
                i++;
                if (i % 2 === 0) playTypeSound(); // 每兩個字播放一次音效，避免太吵
                if(i >= text.length) completeTyping();
            }, 30); // 打字速度 (ms)
        }

        function completeTyping() {
            clearInterval(typingTimer);
            document.getElementById('d-text').innerText = currentText;
            isTyping = false;
        }

        // --- 第一章邏輯 (Stage 1 Logic) ---

        function loadPrologue() {
            gameMode = 'prologue';
            currentScript = prologueScript;
            index = 0;
            
            // 清理第一章的 UI
            document.getElementById('btn-vision').style.display = 'none';
            document.getElementById('code-editor').classList.remove('open');
            document.getElementById('error-msg').style.display = 'none';
            document.getElementById('success-msg').style.display = 'none';
            
            // 確保小遊戲介面完全關閉 (防止卡在畫面上)
            document.getElementById('code-editor').classList.remove('open');
            
            updateGame();
            fadeMusic('crisis');
        }

        function initStage1() {
            gameMode = 'level-intro';
            fadeMusic('stage1'); // 切換到第一章音樂
            loadLevel(1);
        }

        function loadLevel(lv) {
            currentLvl = lv;
            const data = levels[lv];

            // UI 重置
            document.getElementById('file-name').innerText = data.file;
            document.getElementById('btn-vision').style.display = 'none';
            document.getElementById('error-msg').style.display = 'block';
            document.getElementById('success-msg').style.display = 'none';
            
            // 確保編輯器關閉
            document.getElementById('code-editor').classList.remove('open');
            
            // 背景切換
            if (lv === 1) {
                document.querySelectorAll('.bg-layer').forEach(bg => bg.style.opacity = 0);
                document.getElementById('bg-door-closed').style.opacity = 1;
            }

            // 重置按鈕
            const runBtn = document.getElementById('run-btn');
            runBtn.disabled = false;
            runBtn.innerText = "▶ RUN SEQUENCE";
            runBtn.style.background = "var(--accent)";

            // 生成指令塊
            const list = document.getElementById('code-list');
            list.innerHTML = '';
            data.blocks.forEach(b => {
                const div = document.createElement('div');
                div.className = 'code-block';
                div.innerText = b.text;
                div.dataset.id = b.id;
                div.dataset.type = b.type;
                div.dataset.order = b.order || 99;
                div.dataset.msg = b.msg || "";
                initDrag(div); // 綁定拖曳
                list.appendChild(div);
            });

            // 開始關卡前導劇情
            currentScript = data.intro;
            index = -1;
            nextScript();
        }

        function startPuzzle() {
            gameMode = 'level-editor';
            document.getElementById('dialogue-box').style.display = 'none';
            document.getElementById('btn-vision').style.display = 'flex';
            openEditor();
        }

        function nextLevel() {
            if(currentLvl < 3) {
                saveProgress(currentLvl + 1); // 解鎖下一關
                gameMode = 'level-intro';
                loadLevel(currentLvl + 1);
            } else {
                alert("感謝遊玩！第一章結束。");
            }
        }

        function closeArtifact() {
            document.getElementById('artifact-overlay').style.display = 'none';
            document.getElementById('dialogue-box').style.display = 'block';
            nextScript(); // 繼續劇本
        }

        // --- 編輯器與執行 ---
        function openEditor() { document.getElementById('code-editor').classList.add('open'); }
        function closeEditor() { document.getElementById('code-editor').classList.remove('open'); }

        async function runSequence() {
            const list = document.getElementById('code-list');
            const blocks = Array.from(list.children);
            const targetLength = levels[currentLvl].solutionLength;
            const runBtn = document.getElementById('run-btn');
            
            runBtn.disabled = true;
            runBtn.innerText = "RUNNING...";

            // 重置狀態
            blocks.forEach(b => b.classList.remove('running', 'success', 'error', 'ignored'));

            let correctCount = 0;

            for (let i = 0; i < blocks.length; i++) {
                const block = blocks[i];
                block.classList.add('running');
                
                await new Promise(r => setTimeout(r, 600)); 

                if (correctCount >= targetLength) {
                    block.classList.remove('running');
                    block.classList.add('ignored');
                    continue;
                }

                const requiredOrder = i + 1;
                const blockOrder = parseInt(block.dataset.order);

                if (block.dataset.type === 'trap') {
                    block.classList.remove('running');
                    block.classList.add('error');
                    alert(block.dataset.msg);
                    failRun(runBtn);
                    return;
                }

                if (blockOrder === requiredOrder) {
                    block.classList.remove('running');
                    block.classList.add('success');
                    correctCount++;
                } else {
                    block.classList.remove('running');
                    block.classList.add('error');
                    alert("執行錯誤：順序不對！");
                    failRun(runBtn);
                    return;
                }
            }

            if (correctCount >= targetLength) {
                // 成功
                document.getElementById('sfx-success').play();
                saveProgress(currentLvl + 1); // 確保通關後解鎖下一關
                runBtn.style.background = "#00ff41";
                runBtn.innerText = "SUCCESS!";
                document.getElementById('error-msg').style.display = 'none';
                document.getElementById('success-msg').style.display = 'block';

                setTimeout(() => {
                    closeEditor();
                    
                    // 背景切換 (如果是第一關)
                    if (currentLvl === 1) {
                        document.getElementById('bg-door-closed').style.opacity = 0;
                        document.getElementById('bg-hallway').style.opacity = 1;
                    }
                    
                    // 背景切換 (如果是第三關)
                    if (currentLvl === 3) {
                        document.querySelectorAll('.bg-layer').forEach(bg => bg.style.opacity = 0);
                        document.getElementById('bg-final-gate').style.opacity = 1;
                    }

                    // 進入成功劇情
                    gameMode = 'level-success';
                    currentScript = levels[currentLvl].success;
                    index = -1;
                    document.getElementById('dialogue-box').style.display = 'block';
                    nextScript();

                }, 1000);
            } else {
                failRun(runBtn);
            }
        }

        function failRun(btn) {
            btn.innerText = "FAILED - RETRY";
            btn.style.background = "#ff4757";
            setTimeout(() => {
                btn.innerText = "▶ RUN SEQUENCE";
                btn.style.background = "var(--accent)";
                btn.disabled = false;
            }, 1500);
        }

        // --- 拖曳系統 ---
        let dragSrcEl = null;
        let dragMirror = null;

        function initDrag(el) {
            el.addEventListener('mousedown', dragStart);
            el.addEventListener('touchstart', dragStart, {passive: false});
        }

        function dragStart(e) {
            if(document.getElementById('run-btn').disabled) return;
            const target = e.target.closest('.code-block');
            if(!target) return;
            document.getElementById('sfx-drag').play();
            
            dragSrcEl = target;
            const touch = e.touches ? e.touches[0] : e;
            const rect = dragSrcEl.getBoundingClientRect();
            
            dragMirror = dragSrcEl.cloneNode(true);
            dragMirror.classList.add('code-block'); // 確保樣式一致
            dragMirror.style.position = "fixed";
            dragMirror.style.zIndex = 9999;
            dragMirror.style.width = rect.width + 'px';
            dragMirror.style.opacity = 0.9;
            dragMirror.style.transform = "rotate(3deg) scale(1.05)";
            dragMirror.style.left = rect.left + 'px';
            dragMirror.style.top = rect.top + 'px';
            document.body.appendChild(dragMirror);

            dragSrcEl.classList.add('dragging');

            document.addEventListener('mousemove', dragMove);
            document.addEventListener('touchmove', dragMove, {passive: false});
            document.addEventListener('mouseup', dragEnd);
            document.addEventListener('touchend', dragEnd);
        }

        function dragMove(e) {
            e.preventDefault();
            if(!dragMirror) return;
            const touch = e.touches ? e.touches[0] : e;
            dragMirror.style.top = (touch.clientY - 25) + 'px';
            dragMirror.style.left = (touch.clientX - 25) + 'px';

            const elements = document.elementsFromPoint(touch.clientX, touch.clientY);
            const swapTarget = elements.find(el => el.classList.contains('code-block') && el !== dragSrcEl && el !== dragMirror);

            if(swapTarget) {
                const parent = dragSrcEl.parentNode;
                const srcIndex = Array.from(parent.children).indexOf(dragSrcEl);
                const targetIndex = Array.from(parent.children).indexOf(swapTarget);
                if(srcIndex < targetIndex) parent.insertBefore(dragSrcEl, swapTarget.nextSibling);
                else parent.insertBefore(dragSrcEl, swapTarget);
            }
        }

        function dragEnd(e) {
            if(dragSrcEl) dragSrcEl.classList.remove('dragging');
            if(dragMirror) dragMirror.remove();
            dragSrcEl = null; dragMirror = null;
            document.removeEventListener('mousemove', dragMove);
            document.removeEventListener('touchmove', dragMove);
            document.removeEventListener('mouseup', dragEnd);
            document.removeEventListener('touchend', dragEnd);
        }

        // --- 全局點擊特效 ---
        document.addEventListener('click', (e) => {
            const fx = document.createElement('div');
            fx.className = 'click-effect';
            fx.style.left = e.clientX + 'px';
            fx.style.top = e.clientY + 'px';
            document.body.appendChild(fx);
            setTimeout(() => fx.remove(), 400);
        });

        // --- 跳過功能 ---
        function toggleSkip() {
            isSkipping = !isSkipping;
            const btn = document.getElementById('skip-btn');
            
            if(isSkipping) {
                btn.classList.add('active');
                btn.innerText = "SKIPPING...";
                skipLoop();
            } else {
                btn.classList.remove('active');
                btn.innerText = "SKIP >>";
            }
        }

        function skipLoop() {
            if(!isSkipping || !isPlaying) {
                if(isSkipping) toggleSkip(); // 確保狀態同步關閉
                return;
            }
            
            // 執行下一句
            nextScript();
            
            // 如果還沒結束，繼續排程
            if(index < currentScript.length) {
                setTimeout(skipLoop, 100); // 100ms 極速播放
            } else {
                toggleSkip(); // 結束時關閉跳過
            }
        }

        // --- 系統選單邏輯 (章節 + 背包) ---
        const chapters = [
            { id: 0, title: "Prologue: 404 Not Found" },
            { id: 1, title: "Stage 1: 焦慮的兔子" }
        ];

        function openSystemMenu() {
            const menu = document.getElementById('system-menu');
            const list = document.getElementById('chapter-list-container');
            list.innerHTML = '';

            chapters.forEach(c => {
                const btn = document.createElement('div');
                const isUnlocked = c.id <= unlockedProgress;
                
                btn.className = `chapter-btn ${isUnlocked ? 'unlocked' : ''}`;
                btn.innerHTML = `
                    <span>${c.title}</span>
                    <span class="status">${isUnlocked ? '[ ACCESS GRANTED ]' : '[ LOCKED ]'}</span>
                `;
                
                if(isUnlocked) {
                    btn.onclick = () => { playClickSound(); loadChapter(c.id); };
                }
                
                list.appendChild(btn);
            });

            // Render Inventory
            const invList = document.getElementById('inventory-list');
            const descBox = document.getElementById('inventory-desc');
            invList.innerHTML = '';
            descBox.style.display = 'none';
            descBox.innerHTML = '';
            
            // 物品圖片對應表
            const itemImages = {
                "懷錶發條": "https://file.garden/aWe99vhwaGcNwkok/%E6%84%9B%E9%BA%97%E7%B5%B2%E6%A8%82%E5%9C%92/%E5%A0%B4%E6%99%AF%E7%BE%8E%E8%A1%93%E7%B4%A0%E6%9D%90/%E7%AC%AC%E4%B8%80%E7%AB%A0/%E7%99%BC%E6%A2%9D%E6%87%B7%E9%8C%B6.png"
            };
            
            const itemDescs = {
                "懷錶發條": "【外觀描述】 看似一枚古老的黃銅發條，表面卻蝕刻著微小的電路紋理。握在手中時，能感覺到微微的溫熱與脈衝，彷彿它連接著某個巨大的、看不見的心臟。發條周圍偶爾會飄散出 0 與 1 的金色塵埃。\n\n【功能權限】\n\n解鎖能力：Sequence Control (序列控制)\n\n權限等級：Admin (實習生暫用)\n\n效果：允許使用者重新排列事件的執行順序，強制修正因果律錯誤。\n\n【備註】 「拿穩了。這不是普通的金屬，這是我們還能擁有『明天』的唯一理由。」 —— 哈蘇"
            };

            if(playerInventory.length === 0) {
                invList.innerHTML = '<div style="color:#666; width:100%; text-align:center; grid-column:1/-1;">背包是空的</div>';
            } else {
                playerInventory.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'inv-item';
                    div.style.cursor = 'pointer';
                    if(itemImages[item]) {
                        div.innerHTML = `<img src="${itemImages[item]}" style="width:50px; height:50px; object-fit:contain; filter:drop-shadow(0 0 5px var(--primary));"><div class="inv-name">${item}</div>`;
                    } else {
                        div.innerHTML = `<div class="inv-icon">⚙️</div><div class="inv-name">${item}</div>`;
                    }
                    
                    div.onclick = () => {
                        playClickSound();
                        const wasActive = div.classList.contains('active-item');
                        
                        document.querySelectorAll('.inv-item').forEach(i => i.style.borderColor = '#444');
                        document.querySelectorAll('.inv-item').forEach(i => i.classList.remove('active-item'));

                        if (!wasActive) {
                            div.classList.add('active-item');
                            div.style.borderColor = 'var(--primary)';
                            if(itemDescs[item]) {
                                descBox.style.display = 'block';
                                descBox.innerText = itemDescs[item];
                            } else {
                                descBox.style.display = 'none';
                            }
                        } else {
                            descBox.style.display = 'none';
                        }
                    };
                    invList.appendChild(div);
                });
            }

            menu.style.display = 'flex';
        }

        function closeSystemMenu() {
            document.getElementById('system-menu').style.display = 'none';
        }

        function switchTab(tab) {
            document.querySelectorAll('.sys-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sys-content').forEach(c => c.classList.remove('active'));
            
            if(tab === 'chapters') {
                document.querySelector('.sys-tab:nth-child(1)').classList.add('active');
                document.getElementById('tab-chapters').classList.add('active');
            } else if(tab === 'inventory') {
                document.querySelector('.sys-tab:nth-child(2)').classList.add('active');
                document.getElementById('tab-inventory').classList.add('active');
            } else if(tab === 'settings') {
                document.querySelector('.sys-tab:nth-child(3)').classList.add('active');
                document.getElementById('tab-settings').classList.add('active');
            }
        }

        function loadChapter(id) {
            closeSystemMenu();
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('dialogue-box').style.display = 'block';
            isPlaying = true;
            initAudio();

            // 修正：切換章節時重置背包，確保道具不會因為存檔而提前出現
            playerInventory = [];
            localStorage.setItem('wonderland_inventory', JSON.stringify(playerInventory));

            if(id === 0) {
                loadPrologue();
            } else {
                initStage1(); // 切換音樂與背景
                loadLevel(id); // 載入特定關卡
            }
        }

        // --- 音量控制 ---
        function setBgmVolume(val) {
            globalBgmVolume = parseFloat(val);
            if(currentBgm) currentBgm.volume = globalBgmVolume;
        }

        function setSfxVolume(val) {
            globalSfxVolume = parseFloat(val);
            document.querySelectorAll('audio[id^="sfx-"]').forEach(a => a.volume = globalSfxVolume);
            if(dragGainNode) dragGainNode.gain.value = 3.0 * globalSfxVolume;
        }
    </script>
</body>
</html>